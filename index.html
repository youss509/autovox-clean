<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Autovox - Gestion professionnelle de flotte automobile">
    
    <!-- PWA MANIFEST -->
    <link rel="manifest" href="manifest.json">
    
    <!-- ICONS PWA -->
    <link rel="icon" type="image/png" sizes="192x192" href="logo sans fond.jpg">
    <link rel="apple-touch-icon" href="logo sans fond.jpg">
    
    <title>Autovox - Gestion de flotte automobile</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --success: #10b981;
            --success-hover: #059669;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --warning: #f59e0b;
            
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-card: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.05);
            --shadow-hover: rgba(0, 0, 0, 0.1);
        }

        .dark-mode {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --shadow: rgba(0, 0, 0, 0.3);
            --shadow-hover: rgba(0, 0, 0, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background 0.3s, color 0.3s;
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
            position: relative;
        }

        /* === PAGE DE CONNEXION === */
        .login-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, #1e40af 100%);
        }

        .card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 20px 60px var(--shadow-hover);
        }

        .logo-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .logo-badge {
            display: inline-block;
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary), #1e40af);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            overflow: hidden;
        }

        .logo-badge img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 14px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            color: var(--text-primary);
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: inherit;
        }

        .input-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: var(--success-hover);
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-danger:hover {
            background: var(--danger-hover);
        }

        .btn-secondary {
            background: var(--text-secondary);
        }

        .btn-secondary:hover {
            background: var(--text-primary);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
        }

        /* BOUTON EXCEL STYLE NAVIGATEUR */
        .btn-download {
            display: flex;
            align-items: center;
            gap: 6px;
            background: transparent; /* Fond transparent */
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 8px; /* Espace avec d√©connexion */
        }

        .btn-download:hover {
            border-color: #10b981; /* Bordure verte au survol */
            color: #10b981;        /* Texte vert au survol */
            background: rgba(16, 185, 129, 0.05);
        }

        /* Cach√© sur mobile en haut (sera dans le menu d√©roulant) */
        @media (max-width: 768px) {
            .btn-download { display: none; }
        }
        
        .btn-logout {
            padding: 8px 20px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        .alert {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .alert.show {
            display: block;
            animation: shake 0.4s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .footer {
            margin-top: 30px;
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
        }

        /* === DASHBOARD === */
        .dashboard {
            display: none;
            min-height: 100vh;
            background: var(--bg-primary);
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
        }

        .dashboard.active {
            display: flex;
            flex-direction: column;
        }

        /* === HEADER HORIZONTAL === */
        .header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px var(--shadow);
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 32px;
            flex: 1;
            min-width: 0;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: var(--text-primary);
            flex-shrink: 0;
        }

        .header-logo-icon {
            width: 140px;
            height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
        }

        .header-logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .header-logo-text {
            display: none;
        }

        .header-nav {
            display: flex;
            gap: 4px;
            overflow-x: auto;
            flex: 1;
            min-width: 0;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .nav-link:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .nav-link.active {
            background: var(--primary);
            color: white;
        }

        .nav-icon {
            font-size: 18px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .theme-toggle-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .theme-toggle-btn:hover {
            background: var(--bg-primary);
            transform: scale(1.05);
        }

        .hamburger {
            display: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            cursor: pointer;
            font-size: 20px;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        /* === MOBILE MENU === */
        .mobile-menu {
            display: none;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            padding: 16px;
            flex-direction: column;
            gap: 8px;
            box-shadow: 0 4px 12px var(--shadow);
            width: 100%;
            max-width: 100vw;
            overflow-x: hidden;
        }

        .mobile-menu.active {
            display: flex;
        }

        .mobile-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 500;
        }

        .mobile-menu-item:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .mobile-menu-item.active {
            background: var(--primary);
            color: white;
        }

        /* === MAIN CONTENT === */
        .main-wrapper {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px 24px;
            width: 100%;
        }

        .page-content {
            display: none;
            padding: 0 24px;
        }

        .page-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .page-header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .page-header p {
            color: var(--text-secondary);
            font-size: 15px;
        }

        /* === STATS CARDS (4 CARTES COMPACTES) === */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px var(--shadow-hover);
            border-color: var(--primary);
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .stat-card-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card-icon {
            font-size: 24px;
        }

        .stat-card-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .stat-card-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* === WELCOME CARD === */
        .welcome-card {
            background: linear-gradient(135deg, var(--primary), #1e40af);
            border-radius: 20px;
            padding: 48px 32px;
            text-align: center;
            color: white;
        }

        .welcome-card h2 {
            font-size: 28px;
            margin-bottom: 12px;
        }

        .welcome-card p {
            font-size: 16px;
            opacity: 0.9;
        }

        /* === SECTION GRAPHIQUES === */
        .charts-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
        }

        .charts-section h2 {
            font-size: 24px;
            margin-bottom: 24px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
        }
        
        .charts-grid-2x2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
        }
        
        .frais-analysis {
            padding: 20px;
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .frais-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .frais-table tr {
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .frais-table tr:last-child {
            border-bottom: none;
        }
        
        .frais-table td {
            padding: 12px 8px;
            font-size: 14px;
        }
        
        .frais-table td:first-child {
            color: var(--text-secondary);
        }
        
        .frais-table td:last-child {
            text-align: right;
            font-weight: 600;
            color: var(--danger);
            font-size: 16px;
        }
        
        .frais-total {
            margin-top: auto;
            padding-top: 20px;
            border-top: 2px solid rgba(255,255,255,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            flex-wrap: nowrap;
            gap: 10px;
        }

        .frais-total span:last-child {
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        @media (max-width: 1200px) {
            .charts-grid-2x2 {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            min-height: 300px;
            overflow: hidden;
            width: 100%;
        }

        .chart-container h3 {
            font-size: 16px;
            margin-bottom: 16px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        /* Wrapper pour √©viter le d√©bordement des graphiques */
        .chart-wrapper {
            width: 100%;
            max-width: 100%;
            overflow: hidden;
            padding: 0;
            box-sizing: border-box;
            margin: 0 -5px;
        }

        .chart-canvas {
            position: relative;
            height: 250px;
            width: 100%;
            max-width: 100%;
        }

        .chart-canvas canvas {
            max-width: 100% !important;
            height: auto !important;
        }

        /* === FILTERS === */
        .filters {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .filters-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* === GRIDS === */
        .vehicules-grid, .clients-grid, .frais-grid, .ventes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .vehicule-card, .client-card, .frais-card, .vente-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .vehicule-card:hover, .client-card:hover, .frais-card:hover, .vente-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px var(--shadow-hover);
            border-color: var(--primary);
        }

        /* NOUVEAU : Couleurs par b√©n√©fice */
        .vente-card.profit {
            border-color: var(--success);
            background: linear-gradient(to bottom right, var(--bg-card) 0%, rgba(16, 185, 129, 0.05) 100%);
        }

        .vente-card.loss {
            border-color: var(--danger);
            background: linear-gradient(to bottom right, var(--bg-card) 0%, rgba(239, 68, 68, 0.05) 100%);
        }

        .vehicule-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-stock {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .badge-vendu {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .vehicule-card h3, .client-card h3, .frais-card h3, .vente-card h3 {
            font-size: 20px;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .vehicule-info, .client-info, .frais-info, .vente-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }

        .vehicule-info-row, .info-row {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }

        .vehicule-info-label, .info-label {
            color: var(--text-secondary);
        }

        .vehicule-price, .amount {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-top: 8px;
        }

        .amount.positive {
            color: var(--success);
        }

        .amount.negative {
            color: var(--danger);
        }

        .card-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .card-actions button {
            flex: 1;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: var(--bg-card);
            border: 2px dashed var(--border-color);
            border-radius: 16px;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 8px;
        }

        .empty-state p {
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            font-size: 16px;
        }

        /* === MODALS === */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 20px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px var(--shadow-hover);
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h2 {
            font-size: 24px;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: var(--danger);
            color: white;
        }

        .modal-content form {
            padding: 24px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            padding: 24px;
            border-top: 1px solid var(--border-color);
        }

        /* === DETAILS === */
        .detail-section {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-section:last-child {
            border-bottom: none;
        }

        .detail-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .detail-item {
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .detail-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .detail-value.large {
            font-size: 32px;
        }

        .detail-value.positive {
            color: var(--success);
        }

        .detail-value.negative {
            color: var(--danger);
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .header-logo-icon {
                width: 80px;
                height: 80px;
                flex-shrink: 0;
            }

            .header-nav {
                display: none;
            }

            .header {
                padding: 8px 16px;
                overflow-x: hidden;
            }

            .hamburger {
                display: flex;
            }

            .btn-logout {
                display: none;
            }

            .page-header h1 {
                font-size: 24px;
            }

            .stat-card-value {
                font-size: 28px;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .vehicules-grid, .clients-grid, .frais-grid, .ventes-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .main-content {
                padding: 16px;
            }
        }
        
        /* === TABLE CAISSE === */
        .table-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
            margin-top: 24px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table thead {
            background: var(--bg-secondary);
        }
        
        .data-table th {
            padding: 16px;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .data-table td {
            padding: 16px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }
        
        .data-table tbody tr:hover {
            background: var(--bg-secondary);
        }
        
        .data-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .caisse-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
        }
        /* Scroll horizontal pour le tableau caisse sur mobile */
        .caisse-table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 20px 0;
        }

        .caisse-table-wrapper table {
            min-width: 600px;
        }

        @media (max-width: 768px) {
            .caisse-table-wrapper {
                margin: 20px -20px;
            }
        }

        .caisse-type-entree {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .caisse-type-sortie {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .caisse-montant {
            font-weight: 600;
            font-size: 15px;
        }
        
        .caisse-solde-card {
            background: linear-gradient(135deg, var(--primary), #1e40af);
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            color: white;
            margin-bottom: 32px;
        }
        
        .caisse-solde-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .caisse-solde-value {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .caisse-solde-subtitle {
            font-size: 13px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <!-- PAGE DE CONNEXION -->
    <div class="login-container" id="loginPage">
        <div class="card">
            <div class="logo-container">
                <div class="logo-badge">
                    <img src="logo sans fond.jpg" alt="Autovox">
                </div>
            </div>
            <p class="subtitle">Gestion flotte automobile</p>
            
            <div class="alert" id="errorAlert">
                Identifiant ou mot de passe incorrect
            </div>
            
            <form id="loginForm">
                <div class="input-group">
                    <label>Identifiant</label>
                    <input type="text" id="username" placeholder="Votre identifiant" required autocomplete="username">
                </div>
                <div class="input-group">
                    <label>Mot de passe</label>
                    <input type="password" id="password" placeholder="Votre mot de passe" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn">Se connecter</button>
            </form>
        </div>
        <div class="footer">¬© 2026 Autovox ‚Ä¢ Design Premium</div>
    </div>

    <!-- DASHBOARD -->
    <div class="dashboard" id="dashboardPage">
        <!-- HEADER HORIZONTAL -->
        <header class="header">
            <div class="header-left">
                <a href="#" class="header-logo" onclick="navigateToPage('dashboard'); return false;">
                    <div class="header-logo-icon">
                        <img src="logo sans fond.jpg" alt="Autovox">
                    </div>
                    <div class="header-logo-text">Autovox</div>
                </a>
                
                <nav class="header-nav" id="desktopNav">
                    <div class="nav-link active" data-page="dashboard">
                        <span class="nav-icon">üìä</span>
                        <span>Dashboard</span>
                    </div>
                    <div class="nav-link" data-page="vehicules">
                        <span class="nav-icon">üöó</span>
                        <span>V√©hicules</span>
                    </div>
                    <div class="nav-link" data-page="clients">
                        <span class="nav-icon">üë•</span>
                        <span>Clients</span>
                    </div>
                    <div class="nav-link" data-page="frais">
                        <span class="nav-icon">üí∞</span>
                        <span>Frais</span>
                    </div>
                    <div class="nav-link" data-page="caisse">
                        <span class="nav-icon">üíº</span>
                        <span>Caisse</span>
                    </div>

                    <div class="nav-link" data-page="ventes">
                        <span class="nav-icon">üìà</span>
                        <span>Ventes</span>
                    </div>
                    <div class="nav-link" data-page="statistiques">
                        <span class="nav-icon">üìä</span>
                        <span>Statistiques</span>
                    </div>
                </nav>
            </div>
            
            <div class="header-right">
                <!-- 1. BOUTON THEME -->
                <button class="theme-toggle-btn" onclick="toggleTheme()">
                    <span id="themeIcon">üåô</span>
                </button>

                <!-- 2. NOUVEAU BOUTON EXCEL (FL√àCHE BAS) -->
                <button class="btn-download" onclick="exportVehiculesExcel()" title="T√©l√©charger le fichier Excel">
                    <span style="font-size: 16px;">‚¨áÔ∏è</span> Excel
                </button>
                
                <!-- 3. BOUTON D√âCONNEXION -->
                <button class="btn-logout" onclick="logout()">D√©connexion</button>
                
                <!-- 4. MENU MOBILE (HAMBURGER) -->
                <button class="hamburger" onclick="toggleMobileMenu()">
                    <span id="hamburgerIcon">‚ò∞</span>
                </button>
            </div>
        </header>

        <!-- MOBILE MENU -->
        <div class="mobile-menu" id="mobileMenu">
            <div class="mobile-menu-item active" data-page="dashboard">
                <span class="nav-icon">üìä</span>
                <span>Dashboard</span>
            </div>
            <div class="mobile-menu-item" data-page="vehicules">
                <span class="nav-icon">üöó</span>
                <span>V√©hicules</span>
            </div>
            <div class="mobile-menu-item" data-page="clients">
                <span class="nav-icon">üë•</span>
                <span>Clients</span>
            </div>
            <div class="mobile-menu-item" data-page="frais">
                <span class="nav-icon">üí∞</span>
                <span>Frais</span>
            </div>
            <div class="mobile-menu-item" data-page="caisse">
                <span class="nav-icon">üíº</span>
                <span>Caisse</span>
            </div>

            <div class="mobile-menu-item" data-page="ventes">
                <span class="nav-icon">üìà</span>
                <span>Ventes</span>
            </div>
            <div class="mobile-menu-item" data-page="statistiques">
                <span class="nav-icon">üìä</span>
                <span>Statistiques</span>
            </div>
            <div class="mobile-menu-item" onclick="exportVehiculesExcel()">
                <span class="nav-icon">‚¨áÔ∏è</span>
                <span>T√©l√©charger Excel</span>
            </div>
            <div style="border-top: 1px solid var(--border-color); margin: 20px 0; padding-top: 20px;">
                <button class="btn btn-secondary" onclick="logout()" style="width: 100%;">D√©connexion</button>
            </div>
        </div>
        
        <!-- MAIN CONTENT -->
        <div class="main-wrapper">
            <div class="main-content">
                <!-- PAGE DASHBOARD -->
                <div class="page-content active" id="pageDashboard">
                    <div class="page-header">
                        <div class="page-header-left">
                            <h1>Tableau de bord</h1>
                            <p>Vue d'ensemble de votre activit√©</p>
                        </div>
                    </div>
                    
                    <!-- 4 CARTES COMPACTES -->
                    <div class="stats">
                        <div class="stat-card" onclick="showVehiculesStock()">
                            <div class="stat-card-header">
                                <div class="stat-card-title">En stock</div>
                                <div class="stat-card-icon">üöó</div>
                            </div>
                            <div class="stat-card-value" id="vehiculesStock">0</div>
                            <div class="stat-card-subtitle">V√©hicules disponibles</div>
                        </div>
                        
                        <div class="stat-card" onclick="showVehiculesVendus()">
                            <div class="stat-card-header">
                                <div class="stat-card-title">Vendus</div>
                                <div class="stat-card-icon">‚úÖ</div>
                            </div>
                            <div class="stat-card-value" id="vehiculesVendus">0</div>
                            <div class="stat-card-subtitle">V√©hicules vendus</div>
                        </div>
                        
                        <div class="stat-card" onclick="showVentesDetails()">
                            <div class="stat-card-header">
                                <div class="stat-card-title">B√©n√©fice net</div>
                                <div class="stat-card-icon">üí∞</div>
                            </div>
                            <div class="stat-card-value" id="beneficeTotal">0 ‚Ç¨</div>
                            <div class="stat-card-subtitle">Avec frais d√©duits</div>
                        </div>
                        
                        <div class="stat-card" onclick="navigateToPage('caisse')">
                            <div class="stat-card-header">
                                <div class="stat-card-title">Caisse</div>
                                <div class="stat-card-icon">üí∞</div>
                            </div>
                            <div class="stat-card-value" id="soldeCaisse">0 ‚Ç¨</div>
                            <div class="stat-card-subtitle">Solde disponible</div>
                        </div>
                        
                        <div class="stat-card" onclick="navigateToPage('statistiques')">
                            <div class="stat-card-header">
                                <div class="stat-card-title">Statistiques</div>
                                <div class="stat-card-icon">üìä</div>
                            </div>
                            <div class="stat-card-value" id="totalVentesCount">0</div>
                            <div class="stat-card-subtitle">Ventes ce mois</div>
                        </div>
                    </div>

                    <!-- WELCOME CARD -->
                    <div class="welcome-card">
                        <h2>Bienvenue sur Autovox ‚ú®</h2>
                        <p>G√©rez efficacement votre parc automobile</p>
                    </div>
                </div>

                <!-- PAGE STATISTIQUES (NOUVELLE) -->
                <div class="page-content" id="pageStatistiques">
                    <div class="page-header">
                        <div class="page-header-left">
                            <h1>Statistiques</h1>
                            <p>Analyse de vos performances</p>
                        </div>
                    </div>

                    <!-- SECTION GRAPHIQUES -->
                    <div class="charts-section">
                        <h2>üìä Vue d'ensemble</h2>
                        
                        <!-- LIGNE 1 : ACTIVIT√â & VENTES -->
                        <div class="charts-grid-2x2">
                            <div class="chart-container">
                                <h3>üöó V√©hicules vendus par mois</h3>
                                <div class="chart-wrapper">
                                    <div class="chart-canvas">
                                        <canvas id="chartVentes"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="chart-container">
                                <h3>üìà Chiffre d'affaires mensuel</h3>
                                <div class="chart-wrapper">
                                    <div class="chart-canvas">
                                        <canvas id="chartCA"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- LIGNE 2 : RENTABILIT√â -->
                        <div class="charts-grid-2x2" style="margin-top: 20px;">
                            <div class="chart-container">
                                <h3>üí∞ B√©n√©fice net mensuel</h3>
                                <div class="chart-wrapper">
                                    <div class="chart-canvas">
                                        <canvas id="chartBenefice"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="chart-container">
                                <h3>üí∏ Analyse des frais</h3>
                                <div class="frais-analysis">
                                    <div id="fraisTableContainer"></div>
                                    <div class="frais-total">
                                        <span>TOTAL DES FRAIS</span>
                                        <span id="totalFraisGlobal" style="font-size: 24px; font-weight: 700; color: var(--danger);">0 ‚Ç¨</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PAGE CAISSE -->
                <div class="page-content" id="pageCaisse">
                    <div class="page-header">
                        <div class="page-header-left">
                            <h1>üíº Gestion de la Caisse</h1>
                            <p>Suivi des entr√©es et sorties d'argent</p>
                        </div>
                        <div class="page-header-right" style="display: flex; gap: 10px; flex-wrap: wrap;">
    <!-- Nouveau bouton pour les associ√©s -->
    <button class="btn btn-warning" onclick="openModalRetraitCaisse()">
        üí∏ Retrait Associ√©
    </button>
    <!-- Ton bouton actuel -->
    <button class="btn btn-primary" onclick="openModalAjoutCaisse()">
        ‚ûï Ajouter de l'argent
    </button>
</div>
                    </div>

                    <!-- NOUVELLE GRILLE : SOLDE + 4 ASSOCI√âS -->
<div class="stats" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-top: 20px; margin-bottom: 30px;">
    
    <!-- 1. CARTE SOLDE (BLEUE) -->
    <div class="stat-card" style="background: linear-gradient(135deg, var(--primary), #1e40af); color: white; border: none; cursor: pointer;" onclick="resetFilterCaisse()">
        <div class="stat-card-header">
            <div class="stat-card-title" style="color: rgba(255,255,255,0.8);">SOLDE DISPONIBLE</div>
            <div class="stat-card-icon">üíº</div>
        </div>
        <div class="stat-card-value" id="soldeCaisseGrand">0 ‚Ç¨</div>
        <div class="stat-card-subtitle" style="color: rgba(255,255,255,0.8);">En caisse actuellement</div>
    </div>

    <!-- 2. CARTE FOUAD -->
    <div class="stat-card" id="cardFouad" style="cursor: pointer;" onclick="filterCaisseParPersonne('Fouad')">
        <div class="stat-card-header">
            <div class="stat-card-title">Retrait Fouad</div>
            <div class="stat-card-icon">üë§</div>
        </div>
        <div class="stat-card-value" id="retraitFouad" style="color: var(--warning);">0 ‚Ç¨</div>
        <div class="stat-card-subtitle">Total retir√©</div>
    </div>

    <!-- 3. CARTE TAREK -->
    <div class="stat-card" id="cardTarek" style="cursor: pointer;" onclick="filterCaisseParPersonne('Tarek')">
        <div class="stat-card-header">
            <div class="stat-card-title">Retrait Tarek</div>
            <div class="stat-card-icon">üë§</div>
        </div>
        <div class="stat-card-value" id="retraitTarek" style="color: var(--warning);">0 ‚Ç¨</div>
        <div class="stat-card-subtitle">Total retir√©</div>
    </div>

    <!-- 4. CARTE WALID -->
    <div class="stat-card" id="cardWalid" style="cursor: pointer;" onclick="filterCaisseParPersonne('Walid')">
        <div class="stat-card-header">
            <div class="stat-card-title">Retrait Walid</div>
            <div class="stat-card-icon">üë§</div>
        </div>
        <div class="stat-card-value" id="retraitWalid" style="color: var(--warning);">0 ‚Ç¨</div>
        <div class="stat-card-subtitle">Total retir√©</div>
    </div>

    <!-- 5. CARTE RIAD -->
    <div class="stat-card" id="cardRiad" style="cursor: pointer;" onclick="filterCaisseParPersonne('Riad')">
        <div class="stat-card-header">
            <div class="stat-card-title">Retrait Riad</div>
            <div class="stat-card-icon">üë§</div>
        </div>
        <div class="stat-card-value" id="retraitRiad" style="color: var(--warning);">0 ‚Ç¨</div>
        <div class="stat-card-subtitle">Total retir√©</div>
    </div>
</div>

                    <!-- FILTRES -->
                    <div class="filters">
                        <div class="filters-row">
                            <div class="filter-group">
                                <label>Type</label>
                                <select id="filterTypeCaisse" onchange="filterCaisse()">
                                    <option value="">Tous</option>
                                    <option value="entree">Entr√©es</option>
                                    <option value="sortie">Sorties</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Personne</label>
                                <select id="filterPersonne" onchange="filterCaisse()">
                                    <option value="">Toutes</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Date d√©but</label>
                                <input type="date" id="filterDateDebut" onchange="filterCaisse()">
                            </div>
                            <div class="filter-group">
                                <label>Date fin</label>
                                <input type="date" id="filterDateFin" onchange="filterCaisse()">
                            </div>
                        </div>
                    </div>
                    <!-- TABLEAU HISTORIQUE -->
                    <div class="table-container">
                        <div class="caisse-table-wrapper">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Montant</th>
                                        <th>Motif</th>
                                        <th>Personne</th>
                                    </tr>
                                </thead>
                                <tbody id="caisseTableBody">
                                    <tr>
                                        <td colspan="5" style="text-align: center; padding: 40px;">
                                            Chargement...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            
                <!-- PAGE VEHICULES -->
                <div class="page-content" id="pageVehicules">
                    <div class="page-header">
                        <div class="page-header-left">
                            <h1>V√©hicules</h1>
                            <p>Gestion de votre parc automobile</p>
                        </div>
                        <div class="page-header-right">
                            <button class="btn btn-small" onclick="openAddVehiculeModal()">‚ûï Ajouter</button>
                        </div>
                    </div>

                    <div class="filters">
                        <div class="filters-row">
                            <div class="filter-group">
                                <label>Recherche</label>
                                <input type="text" id="searchVehicule" placeholder="Marque, mod√®le, immatriculation..." onkeyup="filterVehicules()">
                            </div>
                            <div class="filter-group">
                                <label>Statut</label>
                                <select id="filterStatut" onchange="filterVehicules()">
                                    <option value="">Tous</option>
                                    <option value="en_stock">En stock</option>
                                    <option value="vendu">Vendu</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="vehiculesContainer">
                        <div class="loading">Chargement des v√©hicules...</div>
                    </div>
                </div>

                <!-- PAGE CLIENTS -->
                <div class="page-content" id="pageClients">
                    <div class="page-header">
                        <div class="page-header-left">
                            <h1>Clients</h1>
                            <p>Gestion de vos clients</p>
                        </div>
                        <div class="page-header-right">
                            <button class="btn btn-small" onclick="openAddClientModal()">‚ûï Ajouter un client</button>
                        </div>
                    </div>

                    <div class="filters">
                        <div class="filters-row">
                            <div class="filter-group">
                                <label>Recherche</label>
                                <input type="text" id="searchClient" placeholder="Nom, pr√©nom, email..." onkeyup="filterClients()">
                            </div>
                        </div>
                    </div>

                    <div id="clientsContainer">
                        <div class="loading">Chargement des clients...</div>
                    </div>
                </div>

                <!-- PAGE FRAIS -->
                <div class="page-content" id="pageFrais">
                    <div class="page-header">
                        <div class="page-header-left">
                            <h1>Frais</h1>
                            <p>Gestion de vos frais v√©hicules</p>
                        </div>
                        <div class="page-header-right">
                            <button class="btn btn-small" onclick="openAddFraisModal()">‚ûï Ajouter des frais</button>
                        </div>
                    </div>

                    <div class="filters">
                        <div class="filters-row">
                            <div class="filter-group">
                                <label>Type de frais</label>
                                <select id="filterTypeFrais" onchange="filterFrais()">
                                   <option value="">S√©lectionnez</option>
                                    <option value="Pi√®ces et main d'oeuvre">Pi√®ces et main d'oeuvre</option>
                                    <option value="Carrosserie/Peinture">Carrosserie/Peinture</option>
                                    <option value="D√©panneuse">D√©panneuse</option>
                                    <option value="D√©claration d'achat">D√©claration d'achat</option>
                                    <option value="Contr√¥le technique">Contr√¥le technique</option>
                                    <option value="Annonce LeBonCoin">Annonce LeBonCoin</option>
                                    <option value="Cl√©s">Cl√©s</option>
                                    <option value="Pneus">Pneus</option>
                                    <option value="Lavage">Lavage</option>
                                    <option value="Essence">Essence</option>
                                    <option value="Entretien">Entretien</option>
                                    <option value="Autre">Autre</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="fraisContainer">
                        <div class="loading">Chargement des frais...</div>
                    </div>
                </div>

                <!-- PAGE VENTES -->
                <div class="page-content" id="pageVentes">
                    <div class="page-header">
                        <div class="page-header-left">
                            <h1>Ventes</h1>
                            <p>Historique de vos ventes avec b√©n√©fice net</p>
                        </div>
                    </div>

                    <div id="ventesContainer">
                        <div class="loading">Chargement des ventes...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL AJOUT VEHICULE -->
    <div class="modal" id="modalAddVehicule">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ajouter un v√©hicule</h2>
                <button class="modal-close" onclick="closeAddVehiculeModal()">‚úï</button>
            </div>
            <form id="formAddVehicule">
                <div class="form-row">
                    <div class="input-group">
                        <label>Marque *</label>
                        <input type="text" name="marque" required>
                    </div>
                    <div class="input-group">
                        <label>Mod√®le *</label>
                        <input type="text" name="modele" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label>Ann√©e *</label>
                        <input type="number" name="annee" min="1900" max="2099" required>
                    </div>
                    <div class="input-group">
                        <label>Immatriculation *</label>
                        <input type="text" name="immatriculation" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label>Prix d'achat (‚Ç¨) *</label>
                        <input type="number" name="prix_achat" step="0.01" required>
                    </div>
                    <div class="input-group">
                        <label>Kilom√©trage (km) *</label>
                        <input type="number" name="kilometrage" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label>Date d'achat *</label>
                        <input type="date" name="date_achat" required>
                    </div>
                    <div class="input-group">
                        <label>Couleur</label>
                        <input type="text" name="couleur">
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label>Type de carburant</label>
                        <select name="carburant">
                            <option value="">Non renseign√©</option>
                            <option value="Essence">Essence</option>
                            <option value="Diesel">Diesel</option>
                            <option value="√âlectrique">√âlectrique</option>
                            <option value="Hybride">Hybride</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Fournisseur</label>
                        <input type="text" name="fournisseur">
                    </div>
                </div>
                <button type="submit" class="btn">Ajouter le v√©hicule</button>
            </form>
        </div>
    </div>
    
    <!-- MODAL AJOUT ARGENT CAISSE -->
    <div class="modal" id="modalAjoutCaisse">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí∞ Ajouter de l'argent</h2>
                <button class="modal-close" onclick="closeModalAjoutCaisse()">‚úï</button>
            </div>
            <form id="formAjoutCaisse" onsubmit="ajouterArgentCaisse(event)">
                <div class="form-row">
                    <div class="input-group">
                        <label>Date *</label>
                        <input type="date" name="date" required>
                    </div>
                    <div class="input-group">
                        <label>Montant (‚Ç¨) *</label>
                        <input type="number" name="montant" step="0.01" min="0.01" required placeholder="Ex: 3000">
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label>Personne *</label>
                        <select name="personne" required>
                            <option value="">S√©lectionnez</option>
                            <option value="Fouad">Fouad</option>
                            <option value="Tarek">Tarek</option>
                            <option value="Walid">Walid</option>
                            <option value="Riad">Riad</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Motif *</label>
                        <input type="text" name="motif" required placeholder="Ex: Apport initial, Compl√©ment caisse...">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">üí∞ Ajouter l'argent</button>
            </form>
        </div>
    </div>

    <!-- MODAL RETRAIT ASSOCI√â (FEN√äTRE POP-UP) -->
    <div class="modal" id="modalRetraitCaisse">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí∏ Nouveau Retrait Associ√©</h2>
                <button class="modal-close" onclick="closeModalRetraitCaisse()">‚úï</button>
            </div>
            <form id="formRetraitCaisse" onsubmit="effectuerRetraitCaisse(event)">
                <div class="form-row">
                    <div class="input-group">
                        <label>Associ√© concern√© *</label>
                        <select name="personne" required>
                            <option value="">S√©lectionnez l'associ√©</option>
                            <option value="Fouad">Fouad</option>
                            <option value="Tarek">Tarek</option>
                            <option value="Walid">Walid</option>
                            <option value="Riad">Riad</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Montant (‚Ç¨) *</label>
                        <input type="number" name="montant" step="0.01" min="0.01" required placeholder="Ex: 500">
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label>Date du retrait *</label>
                        <input type="date" name="date" id="dateRetraitAuto" required>
                    </div>
                    <div class="input-group">
                        <label>Motif / Note</label>
                        <input type="text" name="motif" placeholder="Ex: Avance, Remboursement...">
                    </div>
                </div>
                <button type="submit" class="btn btn-warning">Confirmer le retrait</button>
            </form>
        </div>
    </div>
    
    <!-- MODAL D√âTAILS VEHICULE -->
    <div class="modal" id="modalDetailsVehicule">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="detailsTitle">D√©tails du v√©hicule</h2>
                <button class="modal-close" onclick="closeDetailsModal()">‚úï</button>
            </div>
            
            <div id="detailsContent"></div>
            
            <div class="modal-actions" id="detailsActions"></div>
        </div>
    </div>

    <!-- MODAL MODIFIER VEHICULE -->
    <div class="modal" id="modalEditVehicule">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Modifier le v√©hicule</h2>
                <button class="modal-close" onclick="closeEditModal()">‚úï</button>
            </div>
            <form id="formEditVehicule">
                <input type="hidden" id="editVehiculeId">
                <div class="form-row">
                    <div class="input-group">
                        <label>Marque *</label>
                        <input type="text" id="editMarque" required>
                    </div>
                    <div class="input-group">
                        <label>Mod√®le *</label>
                        <input type="text" id="editModele" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label>Ann√©e *</label>
                        <input type="number" id="editAnnee" min="1900" max="2099" required>
                    </div>
                    <div class="input-group">
                        <label>Immatriculation *</label>
                        <input type="text" id="editImmatriculation" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label>Prix d'achat (‚Ç¨) *</label>
                        <input type="number" id="editPrixAchat" step="0.01" required>
                    </div>
                    <div class="input-group">
                        <label>Kilom√©trage (km) *</label>
                        <input type="number" id="editKilometrage" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label>Date d'achat *</label>
                        <input type="date" id="editDateAchat" required>
                    </div>
                    <div class="input-group">
                        <label>Couleur</label>
                        <input type="text" id="editCouleur">
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label>Type de carburant</label>
                        <select id="editCarburant">
                            <option value="">Non renseign√©</option>
                            <option value="Essence">Essence</option>
                            <option value="Diesel">Diesel</option>
                            <option value="√âlectrique">√âlectrique</option>
                            <option value="Hybride">Hybride</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Fournisseur</label>
                        <input type="text" id="editFournisseur">
                    </div>
                </div>
                <button type="submit" class="btn">Enregistrer les modifications</button>
            </form>
        </div>
    </div>

    <!-- MODAL VENDRE VEHICULE -->
    <div class="modal" id="modalVendreVehicule">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Vendre le v√©hicule</h2>
                <button class="modal-close" onclick="closeVendreModal()">‚úï</button>
            </div>
            <form id="formVendreVehicule">
                <input type="hidden" id="vehiculeIdVente">
                <div class="input-group">
                    <label>Prix de vente (‚Ç¨) *</label>
                    <input type="number" id="prixVente" step="0.01" required>
                </div>
                <div class="input-group">
                    <label>Date de vente *</label>
                    <input type="date" id="dateVente" required>
                </div>
                <div class="input-group">
                    <label>Client (optionnel)</label>
                    <select id="clientVente">
                        <option value="">Aucun client</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success">Confirmer la vente</button>
            </form>
        </div>
    </div>

    <!-- MODAL AJOUT CLIENT -->
    <div class="modal" id="modalAddClient">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ajouter un client</h2>
                <button class="modal-close" onclick="closeAddClientModal()">‚úï</button>
            </div>
            <form id="formAddClient">
                <div class="form-row">
                    <div class="input-group">
                        <label>Nom *</label>
                        <input type="text" name="nom" required>
                    </div>
                    <div class="input-group">
                        <label>Pr√©nom *</label>
                        <input type="text" name="prenom" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label>T√©l√©phone</label>
                        <input type="tel" name="telephone">
                    </div>
                    <div class="input-group">
                        <label>Email</label>
                        <input type="email" name="email">
                    </div>
                </div>
                <div class="input-group">
                    <label>Adresse</label>
                    <textarea name="adresse" rows="3"></textarea>
                </div>
                <button type="submit" class="btn">Ajouter le client</button>
            </form>
        </div>
    </div>

    <!-- MODAL MODIFIER CLIENT -->
    <div class="modal" id="modalEditClient">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Modifier le client</h2>
                <button class="modal-close" onclick="closeEditClientModal()">‚úï</button>
            </div>
            <form id="formEditClient">
                <input type="hidden" id="editClientId">
                <div class="form-row">
                    <div class="input-group">
                        <label>Nom *</label>
                        <input type="text" id="editClientNom" required>
                    </div>
                    <div class="input-group">
                        <label>Pr√©nom *</label>
                        <input type="text" id="editClientPrenom" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label>T√©l√©phone</label>
                        <input type="tel" id="editClientTelephone">
                    </div>
                    <div class="input-group">
                        <label>Email</label>
                        <input type="email" id="editClientEmail">
                    </div>
                </div>
                <div class="input-group">
                    <label>Adresse</label>
                    <textarea id="editClientAdresse" rows="3"></textarea>
                </div>
                <button type="submit" class="btn">Enregistrer les modifications</button>
            </form>
        </div>
    </div>

    <!-- MODAL D√âTAILS CLIENT -->
    <div class="modal" id="modalDetailsClient">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="detailsClientTitle">D√©tails du client</h2>
                <button class="modal-close" onclick="closeDetailsClientModal()">‚úï</button>
            </div>
            
            <div id="detailsClientContent"></div>
            
            <div class="modal-actions" id="detailsClientActions"></div>
        </div>
    </div>

    <!-- MODAL AJOUT FRAIS -->
    <div class="modal" id="modalAddFrais">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ajouter des frais</h2>
                <button class="modal-close" onclick="closeAddFraisModal()">‚úï</button>
            </div>
            <form id="formAddFrais">
                <div class="input-group">
                    <label>V√©hicule concern√© *</label>
                    <select name="vehicule_id" id="selectVehicule" required>
                        <option value="">S√©lectionnez un v√©hicule</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label>Type de frais *</label>
                        <select name="type" id="addFraisType" required>
                            <option value="">S√©lectionnez</option>
                            <option value="Pi√®ces et main d'oeuvre">Pi√®ces et main d'oeuvre</option>
                            <option value="Carrosserie/Peinture">Carrosserie/Peinture</option>
                            <option value="D√©panneuse">D√©panneuse</option>
                            <option value="D√©claration d'achat">D√©claration d'achat</option>
                            <option value="Contr√¥le technique">Contr√¥le technique</option>
                            <option value="Annonce LeBonCoin">Annonce LeBonCoin</option>
                            <option value="Cl√©s">Cl√©s</option>
                            <option value="Pneus">Pneus</option>
                            <option value="Lavage">Lavage</option>
                            <option value="Essence">Essence</option>
                            <option value="Entretien">Entretien</option>
                            <option value="Autre">Autre</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Montant (‚Ç¨) *</label>
                        <input type="number" name="montant" step="0.01" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label>Date *</label>
                        <input type="date" name="date" required>
                    </div>
                    <div class="input-group">
                        <label>Prestataire</label>
                        <input type="text" name="prestataire">
                    </div>
                </div>
                <div class="input-group">
                    <label>Description</label>
                    <textarea name="description" rows="3"></textarea>
                </div>
                <button type="submit" class="btn">Ajouter les frais</button>
            </form>
        </div>
    </div>

    <!-- MODAL MODIFIER FRAIS -->
    <div class="modal" id="modalEditFrais">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Modifier les frais</h2>
                <button class="modal-close" onclick="closeEditFraisModal()">‚úï</button>
            </div>
            <form id="formEditFrais">
                <input type="hidden" id="editFraisId">
                <div class="input-group">
                    <label>V√©hicule concern√© *</label>
                    <select id="editFraisVehicule" required>
                        <option value="">S√©lectionnez un v√©hicule</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label>Type de frais *</label>
                        <select id="editFraisType" required>
                            <option value="">S√©lectionnez</option>
                            <option value="Pi√®ces et main d'oeuvre">Pi√®ces et main d'oeuvre</option>
                            <option value="Carrosserie/Peinture">Carrosserie/Peinture</option>
                            <option value="D√©panneuse">D√©panneuse</option>
                            <option value="D√©claration d'achat">D√©claration d'achat</option>
                            <option value="Contr√¥le technique">Contr√¥le technique</option>
                            <option value="Annonce LeBonCoin">Annonce LeBonCoin</option>
                            <option value="Cl√©s">Cl√©s</option>
                            <option value="Pneus">Pneus</option>
                            <option value="Lavage">Lavage</option>
                            <option value="Essence">Essence</option>
                            <option value="Entretien">Entretien</option>
                            <option value="Autre">Autre</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Montant (‚Ç¨) *</label>
                        <input type="number" id="editFraisMontant" step="0.01" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label>Date *</label>
                        <input type="date" id="editFraisDate" required>
                    </div>
                    <div class="input-group">
                        <label>Prestataire</label>
                        <input type="text" id="editFraisPrestataire">
                    </div>
                </div>
                <div class="input-group">
                    <label>Description</label>
                    <textarea id="editFraisDescription" rows="3"></textarea>
                </div>
                <button type="submit" class="btn">Enregistrer les modifications</button>
            </form>
        </div>
    </div>
    <script>
        // ========== ENREGISTREMENT SERVICE WORKER (PWA) ==========
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(function(registration) {
                        console.log('‚úÖ PWA activ√©e ! Service Worker enregistr√©');
                    })
                    .catch(function(error) {
                        console.log('‚ö†Ô∏è Service Worker non enregistr√©:', error);
                    });
            });
        }

        // Variables globales
        let supabaseClient = null;
        let allVehicules = [];
        let allClients = [];
        let allFrais = [];
        let allVentes = [];
        let allCaisse = [];
        let chartCA = null;
        let chartBenefice = null;
        let chartVentes = null;
        
        // Initialiser Supabase
        function initSupabase() {
            const SUPABASE_URL = 'https://htmpyspelscwftpdrzov.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0bXB5c3BlbHNjd2Z0cGRyem92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NDQ5NTAsImV4cCI6MjA4NjQyMDk1MH0.FKv8RO32kNEI8KQACWlTgvKTn9X8N39HyKza03Rq0lY';
            
            if (window.supabase && !supabaseClient) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            }
        }

        function generateId() {
            return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function toggleTheme() {
            const body = document.body;
            const isDark = body.classList.toggle('dark-mode');
            
            localStorage.setItem('autovox_theme', isDark ? 'dark' : 'light');
            document.getElementById('themeIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            
            const currentPage = document.querySelector('.page-content.active');
            if (currentPage && currentPage.id === 'pageStatistiques') {
                loadCharts();
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('autovox_theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
            }
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const isActive = menu.classList.toggle('active');
            document.getElementById('hamburgerIcon').textContent = isActive ? '‚úï' : '‚ò∞';
        }

        function closeMobileMenu() {
            document.getElementById('mobileMenu').classList.remove('active');
            document.getElementById('hamburgerIcon').textContent = '‚ò∞';
        }

        window.addEventListener('DOMContentLoaded', function() {
            loadTheme();
            if (localStorage.getItem('autovox_session') === 'active') {
                showDashboard();
            }
        });

        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === 'admin' && password === 'autovox2026') {
                localStorage.setItem('autovox_session', 'active');
                showDashboard();
            } else {
                const alert = document.getElementById('errorAlert');
                alert.classList.add('show');
                setTimeout(() => alert.classList.remove('show'), 3000);
            }
        });

        function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboardPage').classList.add('active');
            initSupabase();
            loadStats();
            setupNavigation();
        }

        function setupNavigation() {
            document.querySelectorAll('#desktopNav .nav-link').forEach(item => {
                item.addEventListener('click', function() {
                    const page = this.getAttribute('data-page');
                    navigateToPage(page);
                });
            });

            document.querySelectorAll('.mobile-menu-item').forEach(item => {
                item.addEventListener('click', function() {
                    const page = this.getAttribute('data-page');
                    navigateToPage(page);
                    closeMobileMenu();
                });
            });
        }

        function navigateToPage(page) {
            document.querySelectorAll('#desktopNav .nav-link').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-page') === page) {
                    item.classList.add('active');
                }
            });

            document.querySelectorAll('.mobile-menu-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-page') === page) {
                    item.classList.add('active');
                }
            });

            document.querySelectorAll('.page-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById('page' + page.charAt(0).toUpperCase() + page.slice(1)).classList.add('active');

            if (page === 'vehicules') {
                loadVehicules();
            } else if (page === 'clients') {
                loadClients();
            } else if (page === 'frais') {
                loadFrais();
            } else if (page === 'ventes') {
                loadVentes();
            } else if (page === 'statistiques') {
                loadCharts();
            } else if (page === 'caisse') {
                loadCaisse();
            }
        }

        async function calculateBeneficeNet(vehiculeId, prixVente, prixAchat) {
            try {
                const { data: frais } = await supabaseClient
                    .from('frais')
                    .select('montant')
                    .eq('vehicule_id', vehiculeId);
                
                const totalFrais = frais ? frais.reduce((sum, f) => sum + parseFloat(f.montant), 0) : 0;
                const beneficeBrut = parseFloat(prixVente) - parseFloat(prixAchat);
                const beneficeNet = beneficeBrut - totalFrais;
                
                return {
                    beneficeBrut: beneficeBrut,
                    totalFrais: totalFrais,
                    beneficeNet: beneficeNet
                };
            } catch (error) {
                console.error('Erreur calcul b√©n√©fice:', error);
                return {
                    beneficeBrut: 0,
                    totalFrais: 0,
                    beneficeNet: 0
                };
            }
        }

        async function loadCharts() {
            if (!supabaseClient) return;
            
            try {
                const { data: ventes } = await supabaseClient
                    .from('ventes')
                    .select('*, vehicules(id, prix_achat)')
                    .order('date_vente', { ascending: true });
                
                if (!ventes || ventes.length === 0) {
                    createEmptyCharts();
                    return;
                }
                
                const now = new Date();
                const months = [];
                const labels = [];
                
                for (let i = 5; i >= 0; i--) {
                    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    months.push({
                        year: date.getFullYear(),
                        month: date.getMonth(),
                        label: date.toLocaleDateString('fr-FR', { month: 'short', year: 'numeric' }),
                        ca: 0,
                        benefice: 0,
                        count: 0
                    });
                    labels.push(date.toLocaleDateString('fr-FR', { month: 'short', year: 'numeric' }));
                }
                
                for (const vente of ventes) {
                    const venteDate = new Date(vente.date_vente);
                    const venteMonth = venteDate.getMonth();
                    const venteYear = venteDate.getFullYear();
                    
                    const monthData = months.find(m => m.month === venteMonth && m.year === venteYear);
                    
                    if (monthData) {
                        monthData.ca += parseFloat(vente.prix_vente);
                        monthData.count += 1;
                        
                        const calcul = await calculateBeneficeNet(
                            vente.vehicule_id,
                            vente.prix_vente,
                            vente.vehicules?.prix_achat || 0
                        );
                        monthData.benefice += calcul.beneficeNet;
                    }
                }
                
                const dataCA = months.map(m => Math.round(m.ca));
                const dataBenefice = months.map(m => Math.round(m.benefice));
                const dataCount = months.map(m => m.count);
                
                createCharts(labels, dataCA, dataBenefice, dataCount);
                                
                // Charger l'analyse des frais
                await loadFraisAnalysis();

            } catch (error) {
                console.error('Erreur chargement graphiques:', error);
                createEmptyCharts();
            }
        }

        function createCharts(labels, dataCA, dataBenefice, dataCount) {
            const isDark = document.body.classList.contains('dark-mode');
            const textColor = isDark ? '#94a3b8' : '#64748b';
            const gridColor = isDark ? '#334155' : '#e2e8f0';
            
            if (chartCA) chartCA.destroy();
            if (chartBenefice) chartBenefice.destroy();
            if (chartVentes) chartVentes.destroy();
            
            const ctxCA = document.getElementById('chartCA').getContext('2d');
            chartCA = new Chart(ctxCA, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Chiffre d\'affaires (‚Ç¨)',
                        data: dataCA,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toLocaleString('fr-FR') + ' ‚Ç¨';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { color: textColor },
                            grid: { display: false }
                        }
                    }
                }
            });
            
            const ctxBenefice = document.getElementById('chartBenefice').getContext('2d');
            chartBenefice = new Chart(ctxBenefice, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'B√©n√©fice net (‚Ç¨)',
                        data: dataBenefice,
                        backgroundColor: dataBenefice.map(v => v >= 0 ? 'rgba(16, 185, 129, 0.6)' : 'rgba(239, 68, 68, 0.6)'),
                        borderColor: dataBenefice.map(v => v >= 0 ? '#10b981' : '#ef4444'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toLocaleString('fr-FR') + ' ‚Ç¨';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { color: textColor },
                            grid: { display: false }
                        }
                    }
                }
            });
            
            const ctxVentes = document.getElementById('chartVentes').getContext('2d');
            chartVentes = new Chart(ctxVentes, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'V√©hicules vendus',
                        data: dataCount,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y + ' v√©hicule(s)';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { 
                                color: textColor,
                                stepSize: 1
                            },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { color: textColor },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function createEmptyCharts() {
            const labels = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin'];
            const emptyData = [0, 0, 0, 0, 0, 0];
            createCharts(labels, emptyData, emptyData, emptyData);
        }

        async function loadStats() {
            if (!supabaseClient) return;
            
            try {
                const { data: vehicules } = await supabaseClient.from('vehicules').select('*');
                
                if (vehicules) {
                    const stock = vehicules.filter(v => v.statut === 'en_stock').length;
                    const vendus = vehicules.filter(v => v.statut === 'vendu').length;
                    
                    document.getElementById('vehiculesStock').textContent = stock;
                    document.getElementById('vehiculesVendus').textContent = vendus;
                }

                const { data: ventes } = await supabaseClient
                    .from('ventes')
                    .select('*, vehicules(id, prix_achat)');
                
                if (ventes && ventes.length > 0) {
                    let beneficeNetTotal = 0;
                    
                    const now = new Date();
                    const currentMonth = now.getMonth();
                    const currentYear = now.getFullYear();
                    
                    let ventesThisMonth = 0;
                    
                    for (const vente of ventes) {
                        const calcul = await calculateBeneficeNet(
                            vente.vehicule_id,
                            vente.prix_vente,
                            vente.vehicules?.prix_achat || 0
                        );
                        beneficeNetTotal += calcul.beneficeNet;
                        
                        const venteDate = new Date(vente.date_vente);
                        if (venteDate.getMonth() === currentMonth && venteDate.getFullYear() === currentYear) {
                            ventesThisMonth++;
                        }
                    }
                    
                    document.getElementById('beneficeTotal').textContent = 
                        Math.round(beneficeNetTotal).toLocaleString('fr-FR') + ' ‚Ç¨';
                    
                    document.getElementById('totalVentesCount').textContent = ventesThisMonth;
                }
                      await updateSoldeCaisse();
       
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        async function loadVehicules() {
            if (!supabaseClient) return;
            
            const container = document.getElementById('vehiculesContainer');
            container.innerHTML = '<div class="loading">Chargement des v√©hicules...</div>';
            
            try {
                const { data: vehicules, error } = await supabaseClient
                    .from('vehicules')
                    .select('*')
                    .order('date_achat', { ascending: false });
                
                if (error) throw error;
                
                allVehicules = vehicules || [];
                displayVehicules(allVehicules);
                
            } catch (error) {
                console.error('Erreur:', error);
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><h3>Erreur de chargement</h3></div>';
            }
        }

        function displayVehicules(vehicules) {
            const container = document.getElementById('vehiculesContainer');
            
            if (vehicules.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üöó</div>
                        <h3>Aucun v√©hicule</h3>
                        <p>Commencez par ajouter votre premier v√©hicule</p>
                        <button class="btn btn-small" onclick="openAddVehiculeModal()">‚ûï Ajouter un v√©hicule</button>
                    </div>
                `;
                return;
            }
            
            const html = `
                <div class="vehicules-grid">
                    ${vehicules.map(v => `
                        <div class="vehicule-card" onclick="openVehiculeDetails('${v.id}')">
                            <div class="vehicule-badge ${v.statut === 'en_stock' ? 'badge-stock' : 'badge-vendu'}">
                                ${v.statut === 'en_stock' ? 'üü¢ En stock' : 'üî¥ Vendu'}
                            </div>
                            <h3>${v.marque} ${v.modele}</h3>
                            <div class="vehicule-info">
                                <div class="vehicule-info-row">
                                    <span class="vehicule-info-label">Ann√©e:</span>
                                    <span>${v.annee}</span>
                                </div>
                                <div class="vehicule-info-row">
                                    <span class="vehicule-info-label">Immatriculation:</span>
                                    <span>${v.immatriculation}</span>
                                </div>
                                <div class="vehicule-info-row">
                                    <span class="vehicule-info-label">Kilom√©trage:</span>
                                    <span>${parseInt(v.kilometrage).toLocaleString('fr-FR')} km</span>
                                </div>
                                ${v.couleur ? `
                                <div class="vehicule-info-row">
                                    <span class="vehicule-info-label">Couleur:</span>
                                    <span>${v.couleur}</span>
                                </div>
                                ` : ''}
                            </div>
                            <div class="vehicule-price">${parseFloat(v.prix_achat).toLocaleString('fr-FR')} ‚Ç¨</div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            container.innerHTML = html;
        }

        function filterVehicules() {
            const search = document.getElementById('searchVehicule').value.toLowerCase();
            const statut = document.getElementById('filterStatut').value;
            
            let filtered = allVehicules;
            
            if (search) {
                filtered = filtered.filter(v => 
                    v.marque.toLowerCase().includes(search) ||
                    v.modele.toLowerCase().includes(search) ||
                    v.immatriculation.toLowerCase().includes(search)
                );
            }
            
            if (statut) {
                filtered = filtered.filter(v => v.statut === statut);
            }
            
            displayVehicules(filtered);
        }

        function openAddVehiculeModal() {
            document.getElementById('modalAddVehicule').classList.add('active');
            document.getElementById('formAddVehicule').reset();
        }

        function closeAddVehiculeModal() {
            document.getElementById('modalAddVehicule').classList.remove('active');
        }

        document.getElementById('formAddVehicule').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const vehicule = {
                id: generateId(),
                marque: formData.get('marque'),
                modele: formData.get('modele'),
                annee: parseInt(formData.get('annee')),
                immatriculation: formData.get('immatriculation'),
                prix_achat: parseFloat(formData.get('prix_achat')),
                kilometrage: parseInt(formData.get('kilometrage')),
                date_achat: formData.get('date_achat'),
                couleur: formData.get('couleur') || null,
                carburant: formData.get('carburant') || null,
                fournisseur: formData.get('fournisseur') || null,
                statut: 'en_stock'
            };
            
            try {
                const { error } = await supabaseClient.from('vehicules').insert([vehicule]);
                // AJOUT AUTOMATIQUE EN CAISSE
const caisseAchat = {
    id: 'caisse_' + generateId(),
    date: vehicule.date_achat,
    type: 'sortie',
    montant: vehicule.prix_achat,
    motif: `Achat v√©hicule : ${vehicule.marque} ${vehicule.modele}`,
    personne: 'Syst√®me',
    vehicule_id: vehicule.id // Le lien pour la suppression future
};
await supabaseClient.from('caisse').insert([caisseAchat]);
                if (error) throw error;
                
                closeAddVehiculeModal();
                loadVehicules();
                loadStats();
                alert('‚úÖ V√©hicule ajout√© avec succ√®s !');
                
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur lors de l\'ajout du v√©hicule');
            }
        });

        async function openVehiculeDetails(id) {
            const vehicule = allVehicules.find(v => v.id === id);
            if (!vehicule) return;
            
            const modal = document.getElementById('modalDetailsVehicule');
            const content = document.getElementById('detailsContent');
            const actions = document.getElementById('detailsActions');
            
            document.getElementById('detailsTitle').textContent = `${vehicule.marque} ${vehicule.modele}`;
            
            const { data: frais } = await supabaseClient
                .from('frais')
                .select('*')
                .eq('vehicule_id', id);
            
            const totalFrais = frais ? frais.reduce((sum, f) => sum + parseFloat(f.montant), 0) : 0;
            
            let detailsHTML = `
                <div class="detail-section">
                    <h3>Informations g√©n√©rales</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Marque</div>
                            <div class="detail-value">${vehicule.marque}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Mod√®le</div>
                            <div class="detail-value">${vehicule.modele}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Ann√©e</div>
                            <div class="detail-value">${vehicule.annee}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Immatriculation</div>
                            <div class="detail-value">${vehicule.immatriculation}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Kilom√©trage</div>
                            <div class="detail-value">${parseInt(vehicule.kilometrage).toLocaleString('fr-FR')} km</div>
                        </div>
                        ${vehicule.couleur ? `
                        <div class="detail-item">
                            <div class="detail-label">Couleur</div>
                            <div class="detail-value">${vehicule.couleur}</div>
                        </div>
                        ` : ''}
                        ${vehicule.carburant ? `
                        <div class="detail-item">
                            <div class="detail-label">Carburant</div>
                            <div class="detail-value">${vehicule.carburant}</div>
                        </div>
                        ` : ''}
                        ${vehicule.fournisseur ? `
                        <div class="detail-item">
                            <div class="detail-label">Fournisseur</div>
                            <div class="detail-value">${vehicule.fournisseur}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>

                <div class="detail-section">
                    <h3>Informations financi√®res</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Prix d'achat</div>
                            <div class="detail-value">${parseFloat(vehicule.prix_achat).toLocaleString('fr-FR')} ‚Ç¨</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Date d'achat</div>
                            <div class="detail-value">${new Date(vehicule.date_achat).toLocaleDateString('fr-FR')}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Total des frais</div>
                            <div class="detail-value ${totalFrais > 0 ? 'negative' : ''}">${totalFrais.toLocaleString('fr-FR')} ‚Ç¨</div>
                        </div>
                    </div>
                </div>
            `;
            
            if (frais && frais.length > 0) {
                detailsHTML += `
                    <div class="detail-section">
                        <h3>Frais associ√©s (${frais.length})</h3>
                        ${frais.map(f => `
                            <div class="detail-item" style="margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-primary);">${f.type}</div>
                                        <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">
                                            ${new Date(f.date).toLocaleDateString('fr-FR')}
                                            ${f.description ? ` ‚Ä¢ ${f.description}` : ''}
                                        </div>
                                    </div>
                                    <div style="font-size: 18px; font-weight: 700; color: var(--danger);">
                                        ${parseFloat(f.montant).toLocaleString('fr-FR')} ‚Ç¨
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            if (vehicule.statut === 'vendu') {
                const { data: vente } = await supabaseClient
                    .from('ventes')
                    .select('*, clients(nom, prenom)')
                    .eq('vehicule_id', id)
                    .single();
                
                if (vente) {
                    const calcul = await calculateBeneficeNet(id, vente.prix_vente, vehicule.prix_achat);
                    
                    detailsHTML += `
                        <div class="detail-section">
                            <h3>Informations de vente</h3>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <div class="detail-label">Prix de vente</div>
                                    <div class="detail-value">${parseFloat(vente.prix_vente).toLocaleString('fr-FR')} ‚Ç¨</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Date de vente</div>
                                    <div class="detail-value">${new Date(vente.date_vente).toLocaleDateString('fr-FR')}</div>
                                </div>
                                ${vente.clients ? `
                                <div class="detail-item">
                                    <div class="detail-label">Client</div>
                                    <div class="detail-value">${vente.clients.nom} ${vente.clients.prenom}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <h3>Rentabilit√©</h3>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <div class="detail-label">B√©n√©fice brut</div>
                                    <div class="detail-value ${calcul.beneficeBrut >= 0 ? 'positive' : 'negative'}">
                                        ${calcul.beneficeBrut >= 0 ? '+' : ''}${Math.round(calcul.beneficeBrut).toLocaleString('fr-FR')} ‚Ç¨
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Frais totaux</div>
                                    <div class="detail-value negative">-${Math.round(calcul.totalFrais).toLocaleString('fr-FR')} ‚Ç¨</div>
                                </div>
                                <div class="detail-item" style="grid-column: 1 / -1;">
                                    <div class="detail-label">B√©n√©fice NET</div>
                                    <div class="detail-value large ${calcul.beneficeNet >= 0 ? 'positive' : 'negative'}">
                                        ${calcul.beneficeNet >= 0 ? '+' : ''}${Math.round(calcul.beneficeNet).toLocaleString('fr-FR')} ‚Ç¨
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            content.innerHTML = detailsHTML;
            
            if (vehicule.statut === 'en_stock') {
                actions.innerHTML = `
                    <button class="btn btn-secondary" onclick="closeDetailsModal(); openEditModal('${vehicule.id}')">‚úèÔ∏è Modifier</button>
                    <button class="btn btn-success" onclick="closeDetailsModal(); openVendreModal('${vehicule.id}')">üí∞ Vendre</button>
                    <button class="btn btn-danger" onclick="closeDetailsModal(); deleteVehicule('${vehicule.id}')">üóëÔ∏è Supprimer</button>
                `;
            } else {
                actions.innerHTML = `
                    <button class="btn btn-danger" onclick="closeDetailsModal(); deleteVehicule('${vehicule.id}')">üóëÔ∏è Supprimer</button>
                    <button class="btn btn-secondary" onclick="closeDetailsModal()">Fermer</button>
                `;
            }
            
            modal.classList.add('active');
        }

        function closeDetailsModal() {
            document.getElementById('modalDetailsVehicule').classList.remove('active');
        }

        function openEditModal(id) {
            const vehicule = allVehicules.find(v => v.id === id);
            if (!vehicule) return;
            
            document.getElementById('editVehiculeId').value = vehicule.id;
            document.getElementById('editMarque').value = vehicule.marque;
            document.getElementById('editModele').value = vehicule.modele;
            document.getElementById('editAnnee').value = vehicule.annee;
            document.getElementById('editImmatriculation').value = vehicule.immatriculation;
            document.getElementById('editPrixAchat').value = vehicule.prix_achat;
            document.getElementById('editKilometrage').value = vehicule.kilometrage;
            document.getElementById('editDateAchat').value = vehicule.date_achat;
            document.getElementById('editCouleur').value = vehicule.couleur || '';
            document.getElementById('editCarburant').value = vehicule.carburant || '';
            document.getElementById('editFournisseur').value = vehicule.fournisseur || '';
            
            document.getElementById('modalEditVehicule').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('modalEditVehicule').classList.remove('active');
        }

        document.getElementById('formEditVehicule').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const vehiculeId = document.getElementById('editVehiculeId').value;
            const updatedData = {
                marque: document.getElementById('editMarque').value,
                modele: document.getElementById('editModele').value,
                annee: parseInt(document.getElementById('editAnnee').value),
                immatriculation: document.getElementById('editImmatriculation').value,
                prix_achat: parseFloat(document.getElementById('editPrixAchat').value),
                kilometrage: parseInt(document.getElementById('editKilometrage').value),
                date_achat: document.getElementById('editDateAchat').value,
                couleur: document.getElementById('editCouleur').value || null,
                carburant: document.getElementById('editCarburant').value || null,
                fournisseur: document.getElementById('editFournisseur').value || null
            };
            
            try {
                const { error } = await supabaseClient
                    .from('vehicules')
                    .update(updatedData)
                    .eq('id', vehiculeId);
                
                if (error) throw error;
                
                closeEditModal();
                loadVehicules();
                loadStats();
                alert('‚úÖ V√©hicule modifi√© avec succ√®s !');
                
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur lors de la modification');
            }
        });

        async function deleteVehicule(id) {
            const vehicule = allVehicules.find(v => v.id === id);
            if (!vehicule) return;
            
            const message = vehicule.statut === 'vendu' 
                ? '‚ö†Ô∏è ATTENTION !\n\nCe v√©hicule est vendu. Sa suppression supprimera aussi :\n- La vente associ√©e\n- Tous ses frais\n\nCette action est irr√©versible.\n\n√ätes-vous s√ªr de vouloir supprimer ce v√©hicule ?'
                : '‚ö†Ô∏è ATTENTION !\n\nVous allez supprimer ce v√©hicule et tous ses frais associ√©s.\n\nCette action est irr√©versible.\n\n√ätes-vous s√ªr de continuer ?';
            
            if (!confirm(message)) return;
// Supprime aussi la ligne d'achat en caisse
await supabaseClient.from('caisse').delete().eq('vehicule_id', id);
            
            try {
                const { error } = await supabaseClient
                    .from('vehicules')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                loadVehicules();
                loadStats();
                alert('‚úÖ V√©hicule supprim√© avec succ√®s !');
                
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur lors de la suppression du v√©hicule');
            }
        }

        async function openVendreModal(vehiculeId) {
            document.getElementById('vehiculeIdVente').value = vehiculeId;
            document.getElementById('prixVente').value = '';
            document.getElementById('dateVente').value = new Date().toISOString().split('T')[0];
            
            try {
                const { data: clients } = await supabaseClient.from('clients').select('*').order('nom');
                const select = document.getElementById('clientVente');
                select.innerHTML = '<option value="">Aucun client</option>';
                
                if (clients) {
                    clients.forEach(c => {
                        select.innerHTML += `<option value="${c.id}">${c.nom} ${c.prenom}</option>`;
                    });
                }
            } catch (error) {
                console.error('Erreur chargement clients:', error);
            }
            
            document.getElementById('modalVendreVehicule').classList.add('active');
        }

        function closeVendreModal() {
            document.getElementById('modalVendreVehicule').classList.remove('active');
        }

        document.getElementById('formVendreVehicule').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const vehiculeId = document.getElementById('vehiculeIdVente').value;
            const prixVente = parseFloat(document.getElementById('prixVente').value);
            const dateVente = document.getElementById('dateVente').value;
            const clientId = document.getElementById('clientVente').value || null;
            
            try {
                const { error: errorVehicule } = await supabaseClient
                    .from('vehicules')
                    .update({ statut: 'vendu' })
                    .eq('id', vehiculeId);
                
                if (errorVehicule) throw errorVehicule;
                
                const { error: errorVente } = await supabaseClient
                    .from('ventes')
                    .insert([{
                        id: generateId(),
                        vehicule_id: vehiculeId,
                        client_id: clientId,
                        prix_vente: prixVente,
                        date_vente: dateVente
                    }]);
                
                if (errorVente) throw errorVente;
                
                closeVendreModal();
                loadVehicules();
                loadStats();
                alert('‚úÖ V√©hicule vendu avec succ√®s !');
                
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur lors de la vente');
            }
        });

        async function loadClients() {
            if (!supabaseClient) return;
            
            const container = document.getElementById('clientsContainer');
            container.innerHTML = '<div class="loading">Chargement des clients...</div>';
            
            try {
                const { data: clients, error } = await supabaseClient
                    .from('clients')
                    .select('*')
                    .order('nom');
                
                if (error) throw error;
                
                allClients = clients || [];
                displayClients(allClients);
                
            } catch (error) {
                console.error('Erreur:', error);
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><h3>Erreur de chargement</h3></div>';
            }
        }

        function displayClients(clients) {
            const container = document.getElementById('clientsContainer');
            
            if (clients.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë•</div>
                        <h3>Aucun client</h3>
                        <p>Commencez par ajouter votre premier client</p>
                        <button class="btn btn-small" onclick="openAddClientModal()">‚ûï Ajouter un client</button>
                    </div>
                `;
                return;
            }
            
            const html = `
                <div class="clients-grid">
                    ${clients.map(c => `
                        <div class="client-card" onclick="openClientDetails('${c.id}')">
                            <h3>${c.nom} ${c.prenom}</h3>
                            <div class="client-info">
                                ${c.telephone ? `
                                <div class="info-row">
                                    <span class="info-label">üìû T√©l√©phone:</span>
                                    <span>${c.telephone}</span>
                                </div>
                                ` : ''}
                                ${c.email ? `
                                <div class="info-row">
                                    <span class="info-label">‚úâÔ∏è Email:</span>
                                    <span>${c.email}</span>
                                </div>
                                ` : ''}
                                ${c.adresse ? `
                                <div class="info-row">
                                    <span class="info-label">üìç Adresse:</span>
                                    <span>${c.adresse}</span>
                                </div>
                                ` : ''}
                            </div>
                            <div class="card-actions" onclick="event.stopPropagation();">
                                <button class="btn btn-small btn-secondary" onclick="openEditClientModal('${c.id}')">‚úèÔ∏è Modifier</button>
                                <button class="btn btn-small btn-danger" onclick="deleteClient('${c.id}')">üóëÔ∏è Supprimer</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            container.innerHTML = html;
        }

        function filterClients() {
            const search = document.getElementById('searchClient').value.toLowerCase();
            
            let filtered = allClients;
            
            if (search) {
                filtered = filtered.filter(c => 
                    c.nom.toLowerCase().includes(search) ||
                    c.prenom.toLowerCase().includes(search) ||
                    (c.email && c.email.toLowerCase().includes(search))
                );
            }
            
            displayClients(filtered);
        }

        function openAddClientModal() {
            document.getElementById('modalAddClient').classList.add('active');
            document.getElementById('formAddClient').reset();
        }

        function closeAddClientModal() {
            document.getElementById('modalAddClient').classList.remove('active');
        }

        document.getElementById('formAddClient').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const client = {
                id: generateId(),
                nom: formData.get('nom'),
                prenom: formData.get('prenom'),
                telephone: formData.get('telephone') || null,
                email: formData.get('email') || null,
                adresse: formData.get('adresse') || null
            };
            
            try {
                const { error } = await supabaseClient.from('clients').insert([client]);
                
                if (error) throw error;
                
                closeAddClientModal();
                loadClients();
                alert('‚úÖ Client ajout√© avec succ√®s !');
                
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur lors de l\'ajout du client');
            }
        });

        function openEditClientModal(id) {
            const client = allClients.find(c => c.id === id);
            if (!client) return;
            
            document.getElementById('editClientId').value = client.id;
            document.getElementById('editClientNom').value = client.nom;
            document.getElementById('editClientPrenom').value = client.prenom;
            document.getElementById('editClientTelephone').value = client.telephone || '';
            document.getElementById('editClientEmail').value = client.email || '';
            document.getElementById('editClientAdresse').value = client.adresse || '';
            
            document.getElementById('modalEditClient').classList.add('active');
        }

        function closeEditClientModal() {
            document.getElementById('modalEditClient').classList.remove('active');
        }

        document.getElementById('formEditClient').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const clientId = document.getElementById('editClientId').value;
            const updatedData = {
                nom: document.getElementById('editClientNom').value,
                prenom: document.getElementById('editClientPrenom').value,
                telephone: document.getElementById('editClientTelephone').value || null,
                email: document.getElementById('editClientEmail').value || null,
                adresse: document.getElementById('editClientAdresse').value || null
            };
            
            try {
                const { error } = await supabaseClient
                    .from('clients')
                    .update(updatedData)
                    .eq('id', clientId);
                
                if (error) throw error;
                
                closeEditClientModal();
                loadClients();
                alert('‚úÖ Client modifi√© avec succ√®s !');
                
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur lors de la modification');
            }
        });

        async function deleteClient(id) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce client ?')) return;
            
            try {
                const { error } = await supabaseClient
                    .from('clients')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                loadClients();
                alert('‚úÖ Client supprim√© avec succ√®s !');
                
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur lors de la suppression');
            }
        }

        async function openClientDetails(id) {
            const client = allClients.find(c => c.id === id);
            if (!client) return;
            
            const modal = document.getElementById('modalDetailsClient');
            const content = document.getElementById('detailsClientContent');
            const actions = document.getElementById('detailsClientActions');
            
            document.getElementById('detailsClientTitle').textContent = `${client.nom} ${client.prenom}`;
            
            const { data: ventes } = await supabaseClient
                .from('ventes')
                .select('*, vehicules(marque, modele, immatriculation)')
                .eq('client_id', id)
                .order('date_vente', { ascending: false });
            
            let detailsHTML = `
                <div class="detail-section">
                    <h3>Informations du client</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Nom complet</div>
                            <div class="detail-value">${client.nom} ${client.prenom}</div>
                        </div>
                        ${client.telephone ? `
                        <div class="detail-item">
                            <div class="detail-label">T√©l√©phone</div>
                            <div class="detail-value">${client.telephone}</div>
                        </div>
                        ` : ''}
                        ${client.email ? `
                        <div class="detail-item">
                            <div class="detail-label">Email</div>
                            <div class="detail-value">${client.email}</div>
                        </div>
                        ` : ''}
                        ${client.adresse ? `
                        <div class="detail-item" style="grid-column: 1 / -1;">
                            <div class="detail-label">Adresse</div>
                            <div class="detail-value">${client.adresse}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            if (ventes && ventes.length > 0) {
                detailsHTML += `
                    <div class="detail-section">
                        <h3>Historique des achats (${ventes.length})</h3>
                        ${ventes.map(v => `
                            <div class="detail-item" style="margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-primary);">
                                            ${v.vehicules?.marque} ${v.vehicules?.modele}
                                        </div>
                                        <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">
                                            ${new Date(v.date_vente).toLocaleDateString('fr-FR')} ‚Ä¢ ${v.vehicules?.immatriculation}
                                        </div>
                                    </div>
                                    <div style="font-size: 18px; font-weight: 700; color: var(--primary);">
                                        ${parseFloat(v.prix_vente).toLocaleString('fr-FR')} ‚Ç¨
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                detailsHTML += `
                    <div class="detail-section">
                        <h3>Historique des achats</h3>
                        <p style="color: var(--text-secondary); text-align: center; padding: 20px;">
                            Aucun achat pour le moment
                        </p>
                    </div>
                `;
            }
            
            content.innerHTML = detailsHTML;
            
            actions.innerHTML = `
                <button class="btn btn-secondary" onclick="closeDetailsClientModal(); openEditClientModal('${client.id}')">‚úèÔ∏è Modifier</button>
                <button class="btn btn-danger" onclick="closeDetailsClientModal(); deleteClient('${client.id}')">üóëÔ∏è Supprimer</button>
            `;
            
            modal.classList.add('active');
        }

        function closeDetailsClientModal() {
            document.getElementById('modalDetailsClient').classList.remove('active');
        }

        async function loadFrais() {
            if (!supabaseClient) return;
            
            const container = document.getElementById('fraisContainer');
            container.innerHTML = '<div class="loading">Chargement des frais...</div>';
            
            try {
                const { data: frais, error } = await supabaseClient
                    .from('frais')
                    .select('*, vehicules(marque, modele, immatriculation)')
                    .order('date', { ascending: false });
                
                if (error) throw error;
                
                allFrais = frais || [];
                displayFrais(allFrais);
                
                await loadVehiculesForSelect();
                
            } catch (error) {
                console.error('Erreur:', error);
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><h3>Erreur de chargement</h3></div>';
            }
        }

        async function loadVehiculesForSelect() {
            try {
                const { data: vehicules } = await supabaseClient
                    .from('vehicules')
                    .select('*')
                    .order('marque');
                
                const selects = [
                    document.getElementById('selectVehicule'),
                    document.getElementById('editFraisVehicule')
                ];
                
                selects.forEach(select => {
                    if (select) {
                        select.innerHTML = '<option value="">S√©lectionnez un v√©hicule</option>';
                        
                        if (vehicules) {
                            vehicules.forEach(v => {
                                select.innerHTML += `<option value="${v.id}">${v.marque} ${v.modele} - ${v.immatriculation}</option>`;
                            });
                        }
                    }
                });
            } catch (error) {
                console.error('Erreur chargement v√©hicules:', error);
            }
        }

        function displayFrais(frais) {
            const container = document.getElementById('fraisContainer');
            
            if (frais.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí∞</div>
                        <h3>Aucun frais</h3>
                        <p>Commencez par ajouter vos premiers frais</p>
                        <button class="btn btn-small" onclick="openAddFraisModal()">‚ûï Ajouter des frais</button>
                    </div>
                `;
                return;
            }
            
            const html = `
                <div class="frais-grid">
                    ${frais.map(f => `
                        <div class="frais-card">
                            <h3>${f.type}</h3>
                            <div class="frais-info">
                                <div class="info-row">
                                    <span class="info-label">V√©hicule:</span>
                                    <span>${f.vehicules?.marque} ${f.vehicules?.modele}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Date:</span>
                                    <span>${new Date(f.date).toLocaleDateString('fr-FR')}</span>
                                </div>
                                ${f.prestataire ? `
                                <div class="info-row">
                                    <span class="info-label">Prestataire:</span>
                                    <span>${f.prestataire}</span>
                                </div>
                                ` : ''}
                                ${f.description ? `
                                <div class="info-row">
                                    <span class="info-label">Description:</span>
                                    <span>${f.description}</span>
                                </div>
                                ` : ''}
                            </div>
                            <div class="amount negative">${parseFloat(f.montant).toLocaleString('fr-FR')} ‚Ç¨</div>
                            <div class="card-actions">
                                <button class="btn btn-small btn-secondary" onclick="openEditFraisModal('${f.id}')">‚úèÔ∏è Modifier</button>
                                <button class="btn btn-small btn-danger" onclick="deleteFrais('${f.id}')">üóëÔ∏è Supprimer</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            container.innerHTML = html;
        }

        function filterFrais() {
            const type = document.getElementById('filterTypeFrais').value;
            
            let filtered = allFrais;
            
            if (type) {
                filtered = filtered.filter(f => f.type === type);
            }
            
            displayFrais(filtered);
        }

        function openAddFraisModal() {
            document.getElementById('modalAddFrais').classList.add('active');
            document.getElementById('formAddFrais').reset();
        }

        function closeAddFraisModal() {
            document.getElementById('modalAddFrais').classList.remove('active');
        }

        // ============================================
        // MODIFICATION 1 : AJOUT DE FRAIS SYNCHRONIS√â
        // ============================================
        document.getElementById('formAddFrais').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const fraisId = generateId(); // ID unique pour les deux tables
            
            // 1. Objet Frais
            const frais = {
                id: fraisId,
                vehicule_id: formData.get('vehicule_id'),
                type: formData.get('type'),
                montant: parseFloat(formData.get('montant')),
                date: formData.get('date'),
                prestataire: formData.get('prestataire') || null,
                description: formData.get('description') || null
            };

            // 2. Objet Caisse (Sortie) li√©
            const caisseSortie = {
                id: generateId(),
                date: frais.date,
                type: 'sortie',
                montant: frais.montant,
                motif: `Frais: ${frais.type}`,
                personne: 'Automatique',
                frais_id: fraisId // Lien cl√© √©trang√®re
            };
            
            try {
                // Insertion table Frais
                const { error: errorFrais } = await supabaseClient.from('frais').insert([frais]);
                if (errorFrais) throw errorFrais;

                // Insertion table Caisse
                const { error: errorCaisse } = await supabaseClient.from('caisse').insert([caisseSortie]);
                if (errorCaisse) console.error("Erreur synchro caisse:", errorCaisse);
                
                closeAddFraisModal();
                loadFrais();
                loadStats(); // Met √† jour le solde aussi
                alert('‚úÖ Frais ajout√©s et d√©bit√©s de la caisse !');
                
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur lors de l\'ajout des frais');
            }
        });

        function openEditFraisModal(id) {
            const frais = allFrais.find(f => f.id === id);
            if (!frais) return;
            
            document.getElementById('editFraisId').value = frais.id;
            document.getElementById('editFraisVehicule').value = frais.vehicule_id;
            document.getElementById('editFraisType').value = frais.type;
            document.getElementById('editFraisMontant').value = frais.montant;
            document.getElementById('editFraisDate').value = frais.date;
            document.getElementById('editFraisPrestataire').value = frais.prestataire || '';
            document.getElementById('editFraisDescription').value = frais.description || '';
            
            document.getElementById('modalEditFrais').classList.add('active');
        }

        function closeEditFraisModal() {
            document.getElementById('modalEditFrais').classList.remove('active');
        }

        // ============================================
        // MODIFICATION 2 : √âDITION DE FRAIS SYNCHRONIS√âE
        // ============================================
        document.getElementById('formEditFrais').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fraisId = document.getElementById('editFraisId').value;
            const typeFrais = document.getElementById('editFraisType').value;
            const nouveauMontant = parseFloat(document.getElementById('editFraisMontant').value);
            const nouvelleDate = document.getElementById('editFraisDate').value;

            const updatedData = {
                vehicule_id: document.getElementById('editFraisVehicule').value,
                type: typeFrais,
                montant: nouveauMontant,
                date: nouvelleDate,
                prestataire: document.getElementById('editFraisPrestataire').value || null,
                description: document.getElementById('editFraisDescription').value || null
            };
            
            try {
                // 1. Update Frais
                const { error: errorFrais } = await supabaseClient
                    .from('frais')
                    .update(updatedData)
                    .eq('id', fraisId);
                
                if (errorFrais) throw errorFrais;

                // 2. Update Caisse via frais_id
                const updatedCaisseData = {
                    montant: nouveauMontant,
                    date: nouvelleDate,
                    motif: `Frais: ${typeFrais} (Modifi√©)`
                };

                const { error: errorCaisse } = await supabaseClient
                    .from('caisse')
                    .update(updatedCaisseData)
                    .eq('frais_id', fraisId);

                if (errorCaisse) console.error("Erreur update caisse:", errorCaisse);
                
                closeEditFraisModal();
                loadFrais();
                loadStats();
                alert('‚úÖ Frais et Caisse mis √† jour avec succ√®s !');
                
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur lors de la modification');
            }
        });

        // ============================================
        // MODIFICATION 3 : SUPPRESSION SYNCHRONIS√âE
        // ============================================
        async function deleteFrais(id) {
            if (!confirm('‚ö†Ô∏è ATTENTION : Supprimer ce frais va aussi r√©-cr√©diter la caisse (suppression de la ligne de sortie).\n\nContinuer ?')) return;
            
            try {
                // 1. Supprimer de la caisse
                const { error: errorCaisse } = await supabaseClient
                    .from('caisse')
                    .delete()
                    .eq('frais_id', id);
                
                if (errorCaisse) console.warn("Ligne caisse non trouv√©e ou erreur", errorCaisse);

                // 2. Supprimer le frais
                const { error: errorFrais } = await supabaseClient
                    .from('frais')
                    .delete()
                    .eq('id', id);
                
                if (errorFrais) throw errorFrais;
                
                loadFrais();
                loadStats();
                alert('‚úÖ Frais supprim√© et caisse r√©gularis√©e !');
                
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur lors de la suppression');
            }
        }

        async function loadVentes() {
            if (!supabaseClient) return;
            
            const container = document.getElementById('ventesContainer');
            container.innerHTML = '<div class="loading">Chargement des ventes...</div>';
            
            try {
                const { data: ventes, error } = await supabaseClient
                    .from('ventes')
                    .select('*, vehicules(id, marque, modele, immatriculation, prix_achat), clients(nom, prenom)')
                    .order('date_vente', { ascending: false });
                
                if (error) throw error;
                
                allVentes = ventes || [];
                displayVentes(allVentes);
                
            } catch (error) {
                console.error('Erreur:', error);
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><h3>Erreur de chargement</h3></div>';
            }
        }

        async function displayVentes(ventes) {
            const container = document.getElementById('ventesContainer');
            
            if (ventes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìà</div>
                        <h3>Aucune vente</h3>
                        <p>Vos ventes appara√Ætront ici</p>
                    </div>
                `;
                return;
            }
            
            const ventesAvecBenefice = await Promise.all(ventes.map(async v => {
                const calcul = await calculateBeneficeNet(
                    v.vehicule_id,
                    v.prix_vente,
                    v.vehicules?.prix_achat || 0
                );
                return { ...v, ...calcul };
            }));
            
            const html = `
                <div class="ventes-grid">
                    ${ventesAvecBenefice.map(v => `
                        <div class="vente-card ${v.beneficeNet >= 0 ? 'profit' : 'loss'}">
                            <h3>${v.vehicules?.marque} ${v.vehicules?.modele}</h3>
                            <div class="vente-info">
                                <div class="info-row">
                                    <span class="info-label">Immatriculation:</span>
                                    <span>${v.vehicules?.immatriculation}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Date de vente:</span>
                                    <span>${new Date(v.date_vente).toLocaleDateString('fr-FR')}</span>
                                </div>
                                ${v.clients ? `
                                <div class="info-row">
                                    <span class="info-label">Client:</span>
                                    <span>${v.clients.nom} ${v.clients.prenom}</span>
                                </div>
                                ` : ''}
                                <div class="info-row">
                                    <span class="info-label">Prix d'achat:</span>
                                    <span>${parseFloat(v.vehicules?.prix_achat || 0).toLocaleString('fr-FR')} ‚Ç¨</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Prix de vente:</span>
                                    <span>${parseFloat(v.prix_vente).toLocaleString('fr-FR')} ‚Ç¨</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">B√©n√©fice brut:</span>
                                    <span style="font-weight: 600; color: ${v.beneficeBrut >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                        ${v.beneficeBrut >= 0 ? '+' : ''}${Math.round(v.beneficeBrut).toLocaleString('fr-FR')} ‚Ç¨
                                    </span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Frais:</span>
                                    <span style="color: var(--danger); font-weight: 600;">
                                        -${Math.round(v.totalFrais).toLocaleString('fr-FR')} ‚Ç¨
                                    </span>
                                </div>
                            </div>
                            <div class="amount ${v.beneficeNet >= 0 ? 'positive' : 'negative'}">
                                ${v.beneficeNet >= 0 ? '+' : ''}${Math.round(v.beneficeNet).toLocaleString('fr-FR')} ‚Ç¨
                                <div style="font-size: 12px; font-weight: normal; margin-top: 4px; opacity: 0.8;">B√©n√©fice NET</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            container.innerHTML = html;
        }

        function showVehiculesStock() {
            navigateToPage('vehicules');
            setTimeout(() => {
                document.getElementById('filterStatut').value = 'en_stock';
                filterVehicules();
            }, 300);
        }

        function showVehiculesVendus() {
            navigateToPage('vehicules');
            setTimeout(() => {
                document.getElementById('filterStatut').value = 'vendu';
                filterVehicules();
            }, 300);
        }

        function showVentesDetails() {
            navigateToPage('ventes');
        }

        function logout() {
            localStorage.removeItem('autovox_session');
            location.reload();
        }
        
        // ========== GESTION CAISSE ==========
        
        // Ouvrir le modal d'ajout d'argent
        function openModalAjoutCaisse() {
            document.getElementById('modalAjoutCaisse').classList.add('active');
            // Mettre la date du jour par d√©faut
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('#formAjoutCaisse input[name="date"]').value = today;
        }
        
        // Fermer le modal
        function closeModalAjoutCaisse() {
            document.getElementById('modalAjoutCaisse').classList.remove('active');
            document.getElementById('formAjoutCaisse').reset();
        }

        // Ouvrir la fen√™tre de retrait
        function openModalRetraitCaisse() {
            document.getElementById('modalRetraitCaisse').classList.add('active');
            // Mettre la date du jour par d√©faut
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateRetraitAuto').value = today;
        }

        // Fermer la fen√™tre de retrait
        function closeModalRetraitCaisse() {
            document.getElementById('modalRetraitCaisse').classList.remove('active');
            document.getElementById('formRetraitCaisse').reset();
        }

        async function effectuerRetraitCaisse(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const personne = formData.get('personne');
            const montant = parseFloat(formData.get('montant'));

            const retrait = {
                id: generateId(),
                date: formData.get('date'),
                type: 'sortie', // On le garde en sortie pour que le solde baisse
                montant: montant,
                personne: personne,
                // On ajoute un marqueur sp√©cial dans le motif pour le reconna√Ætre
                motif: `RETRAIT ASSOCI√â: ${formData.get('motif') || 'Sans motif'}`
            };

            try {
                const { error } = await supabaseClient.from('caisse').insert([retrait]);
                if (error) throw error;

                alert('‚úÖ Retrait enregistr√© !');
                closeModalRetraitCaisse();
                loadCaisse(); // Cette fonction va rafra√Æchir ton tableau et ton solde
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur lors de l\'enregistrement');
            }
        }
        
        // Charger les donn√©es de la caisse
        async function loadCaisse() {
            try {
                const { data, error } = await supabaseClient
                    .from('caisse')
                    .select('*')
                    .order('date', { ascending: false });
                
                if (error) throw error;
                
                allCaisse = data || [];
                displayCaisse(allCaisse);
                updateSoldeCaisse();
                updateFilterPersonnes();
                
            } catch (error) {
                console.error('Erreur chargement caisse:', error);
                showNotification('Erreur lors du chargement de la caisse', 'error');
            }
        } 

        // ========== ANALYSE DES FRAIS ==========
        async function loadFraisAnalysis() {
            if (!supabaseClient) return;
            
            try {
                const { data: frais, error } = await supabaseClient
                    .from('frais')
                    .select('type, montant');
                
                if (error) throw error;
                
                if (!frais || frais.length === 0) {
                    document.getElementById('fraisTableContainer').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            üí∏ Aucun frais enregistr√©
                        </div>
                    `;
                    document.getElementById('totalFraisGlobal').textContent = '0 ‚Ç¨';
                    return;
                }
                
                // Regrouper par type
                const fraisParType = {};
                let totalGeneral = 0;
                
                frais.forEach(f => {
                    const type = f.type || 'Autre';
                    const montant = parseFloat(f.montant) || 0;
                    
                    if (!fraisParType[type]) {
                        fraisParType[type] = 0;
                    }
                    fraisParType[type] += montant;
                    totalGeneral += montant;
                });
                
                // Trier par montant d√©croissant
                const fraisTri√©s = Object.entries(fraisParType)
                    .sort((a, b) => b[1] - a[1]);
                
                // Afficher le tableau
                const tableHTML = `
                    <table class="frais-table">
                        ${fraisTri√©s.map(([type, montant]) => `
                            <tr>
                                <td>${type}</td>
                                <td style="white-space: nowrap;">${Math.round(montant).toLocaleString('fr-FR')}&nbsp;‚Ç¨</td>
                            </tr>
                        `).join('')}
                    </table>
                `;
                
                document.getElementById('fraisTableContainer').innerHTML = tableHTML;
                document.getElementById('totalFraisGlobal').textContent = 
                    Math.round(totalGeneral).toLocaleString('fr-FR') + ' ‚Ç¨';
                
            } catch (error) {
                console.error('Erreur chargement analyse frais:', error);
                document.getElementById('fraisTableContainer').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--danger);">
                        ‚ö†Ô∏è Erreur de chargement
                    </div>
                `;
            }
        }

        // ========================================
        // FONCTION POUR FORMATER LES DATES
        // ========================================
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // ========================================
        // FONCTION POUR AFFICHER LES NOTIFICATIONS
        // ========================================
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                background: ${type === 'success' ? '#10b981' : '#ef4444'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: 500;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

       // Nouvelle fonction pour afficher l'historique et les cartes des associ√©s
        function displayCaisse(caisse) {
            const tbody = document.getElementById('caisseTableBody');
            
            // 1. On r√©initialise les compteurs √† z√©ro
            let totaux = { 'Fouad': 0, 'Tarek': 0, 'Walid': 0, 'Riad': 0 };

            // 2. On calcule les totaux pour chaque associ√©
            caisse.forEach(transaction => {
                if (transaction.type === 'sortie' && transaction.motif && transaction.motif.includes('RETRAIT ASSOCI√â')) {
                    if (totaux.hasOwnProperty(transaction.personne)) {
                        totaux[transaction.personne] += parseFloat(transaction.montant);
                    }
                }
            });

            // 3. On met √† jour les chiffres dans les cartes en haut
            if(document.getElementById('retraitFouad')) {
                document.getElementById('retraitFouad').textContent = totaux['Fouad'].toLocaleString('fr-FR') + ' ‚Ç¨';
                document.getElementById('retraitTarek').textContent = totaux['Tarek'].toLocaleString('fr-FR') + ' ‚Ç¨';
                document.getElementById('retraitWalid').textContent = totaux['Walid'].toLocaleString('fr-FR') + ' ‚Ç¨';
                document.getElementById('retraitRiad').textContent = totaux['Riad'].toLocaleString('fr-FR') + ' ‚Ç¨';
            }

            // 4. On dessine le tableau en bas
            if (!caisse || caisse.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 40px;">üí∞ Aucune transaction</td></tr>`;
                return;
            }
            
            tbody.innerHTML = caisse.map(c => {
                const isEntree = c.type === 'entree';
                const isRetrait = c.motif && c.motif.includes('RETRAIT ASSOCI√â');
                
                const typeIcon = isRetrait ? 'üí∏' : (isEntree ? '‚Üó' : '‚Üò');
                const typeClass = isRetrait ? 'caisse-type-sortie' : (isEntree ? 'caisse-type-entree' : 'caisse-type-sortie');
                const typeLabel = isRetrait ? 'Retrait' : (isEntree ? 'Entr√©e' : 'Sortie');
                const montantSign = isEntree ? '+' : '-';
                
                const montantColor = isRetrait ? 'var(--warning)' : (isEntree ? 'var(--success)' : 'var(--danger)');
                
                return `
                    <tr>
                        <td>${formatDate(c.date)}</td>
                        <td>
                            <span class="caisse-type-badge ${typeClass}" style="${isRetrait ? 'background: rgba(245, 158, 11, 0.1); color: var(--warning);' : ''}">
                                ${typeIcon} ${typeLabel}
                            </span>
                        </td>
                        <td class="caisse-montant" style="color: ${montantColor};">
                            ${montantSign}${parseFloat(c.montant).toFixed(2)} ‚Ç¨
                        </td>
                        <td style="font-size: 13px;">${c.motif || '-'}</td>
                        <td style="font-weight: 600;">${c.personne || '-'}</td>
                        <!-- On ajoute cette colonne pour la poubelle -->
                        <td style="text-align: right;">
                            <button onclick="deleteTransactionCaisse('${c.id}')" style="background: none; border: none; cursor: pointer; font-size: 16px; padding: 5px;" title="Supprimer">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Mettre √† jour le solde de la caisse
        async function updateSoldeCaisse() {
            try {
                const { data, error } = await supabaseClient
                    .rpc('get_solde_caisse');
                
                if (error) throw error;
                
                const solde = data || 0;
                const soldeFormate = solde.toFixed(2) + ' ‚Ç¨';
                
                // Mettre √† jour le solde dans la page Caisse
                const soldeCaisseGrand = document.getElementById('soldeCaisseGrand');
                if (soldeCaisseGrand) {
                    soldeCaisseGrand.textContent = soldeFormate;
                    soldeCaisseGrand.style.color = solde >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
                }
                
                // Mettre √† jour le solde dans la carte du dashboard
                const soldeCaisse = document.getElementById('soldeCaisse');
                if (soldeCaisse) {
                    soldeCaisse.textContent = soldeFormate;
                }
                
                // Mettre √† jour la date
                const derniereMaj = document.getElementById('derniereMaj');
                if (derniereMaj) {
                    derniereMaj.textContent = new Date().toLocaleString('fr-FR');
                }
                
            } catch (error) {
                console.error('Erreur calcul solde:', error);
            }
        }
        
        // Ajouter de l'argent dans la caisse
        async function ajouterArgentCaisse(e) {
            e.preventDefault();
            
            const form = e.target;
            const formData = new FormData(form);
            
            const caisse = {
                id: generateId(),
                date: formData.get('date'),
                type: 'entree',
                montant: parseFloat(formData.get('montant')),
                personne: formData.get('personne'),
                motif: formData.get('motif')
            };
            
            try {
                const { data, error } = await supabaseClient
                    .from('caisse')
                    .insert([caisse])
                    .select();
                
                if (error) throw error;
                
                showNotification('üí∞ Argent ajout√© avec succ√®s !', 'success');
                closeModalAjoutCaisse();
                loadCaisse();
                
            } catch (error) {
                console.error('Erreur ajout argent:', error);
                showNotification('Erreur lors de l\'ajout', 'error');
            }
        }
        
        // Filtrer la caisse
        function filterCaisse() {
            const typeCaisse = document.getElementById('filterTypeCaisse').value;
            const personne = document.getElementById('filterPersonne').value;
            const dateDebut = document.getElementById('filterDateDebut').value;
            const dateFin = document.getElementById('filterDateFin').value;
            
            let filtered = allCaisse;
            
            if (typeCaisse) {
                filtered = filtered.filter(c => c.type === typeCaisse);
            }
            
            if (personne) {
                filtered = filtered.filter(c => c.personne === personne);
            }
            
            if (dateDebut) {
                filtered = filtered.filter(c => c.date >= dateDebut);
            }
            
            if (dateFin) {
                filtered = filtered.filter(c => c.date <= dateFin);
            }
            
            displayCaisse(filtered);
        }
        
        // Mettre √† jour le filtre des personnes
        function updateFilterPersonnes() {
            const select = document.getElementById('filterPersonne');
            const personnes = [...new Set(allCaisse
                .filter(c => c.personne)
                .map(c => c.personne))];
            
            select.innerHTML = '<option value="">Toutes</option>';
            personnes.forEach(p => {
                select.innerHTML += `<option value="${p}">${p}</option>`;
            });
        }
        // ==========================================
// EXPORT EXCEL (VERSION FINALE)
// ==========================================
async function exportVehiculesExcel() {
    // Petit curseur de chargement
    document.body.style.cursor = 'wait';

    try {
        // 1. R√©cup√©ration des donn√©es
        const { data: vehicules, error } = await supabaseClient
            .from('vehicules')
            .select('*, frais(*), ventes(*)')
            .order('date_achat', { ascending: false });

        if (error) throw error;

        // 2. En-t√™te du tableau
        const rows = [
            ["MARQUE", "MODELE", "PLAQUE", "KM", "PIECES MO", "CARROSSERIE", "DEPANNEUSE", "FRAIS ADMIN (DA+CT+LBC)", "LAVAGE", "ESSENCE", "PRIX ACHAT", "PRIX TOTAL", "PRIX VENTE", "B√âN√âFICE"]
        ];

        // 3. Remplissage
        vehicules.forEach(v => {
            const frais = v.frais || [];
            
            // Fonction helper pour sommer
            const sum = (type) => frais.filter(f => f.type === type).reduce((t, f) => t + parseFloat(f.montant), 0);

            // Calculs frais techniques
            const mtPieces = sum("Pi√®ces et main d'oeuvre");
            const mtCarrosserie = sum("Carrosserie/Peinture");
            const mtDepanneuse = sum("D√©panneuse");
            const mtLavage = sum("Lavage");
            const mtEssence = sum("Essence");

            // Calculs frais admin group√©s (Texte combin√©)
            const typesAdmin = ["D√©claration d'achat", "Contr√¥le technique", "Annonce LeBonCoin", "Cl√©s", "Autre"];
            const fraisAdmin = frais.filter(f => typesAdmin.includes(f.type));
            const mtAdminTotal = fraisAdmin.reduce((t, f) => t + parseFloat(f.montant), 0);
            
            // Cr√©ation du texte "DA 10 + CT 60"
            const texteAdmin = fraisAdmin.map(f => {
                let nom = f.type
                    .replace("D√©claration d'achat", "DA")
                    .replace("Contr√¥le technique", "CT")
                    .replace("Annonce LeBonCoin", "LBC");
                return `${nom} ${Math.round(f.montant)}‚Ç¨`;
            }).join(" + ");

            // Calculs financiers
            const prixAchat = parseFloat(v.prix_achat || 0);
            const prixTotal = prixAchat + mtPieces + mtCarrosserie + mtDepanneuse + mtAdminTotal + mtLavage + mtEssence;
            
            let prixVente = "", benefice = "";
            if (v.ventes && v.ventes.length > 0) {
                prixVente = parseFloat(v.ventes[0].prix_vente);
                benefice = prixVente - prixTotal;
            }

            // Ajout ligne
            rows.push([
                v.marque, v.modele, v.immatriculation, v.kilometrage,
                mtPieces || "", mtCarrosserie || "", mtDepanneuse || "",
                texteAdmin, mtLavage || "", mtEssence || "",
                prixAchat + "‚Ç¨", Math.round(prixTotal) + "‚Ç¨", 
                prixVente ? prixVente + "‚Ç¨" : "", 
                benefice !== "" ? Math.round(benefice) + "‚Ç¨" : ""
            ]);
        });

        // 4. G√©n√©ration du fichier
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(rows);

        // Largeurs colonnes
        ws['!cols'] = [{wch:15}, {wch:15}, {wch:12}, {wch:8}, {wch:15}, {wch:15}, {wch:12}, {wch:35}, {wch:10}, {wch:10}, {wch:12}, {wch:12}, {wch:12}, {wch:12}];

        XLSX.utils.book_append_sheet(wb, ws, "Flotte Auto");
        XLSX.writeFile(wb, "Autovox_Export.xlsx");
        
    } catch (err) {
        console.error(err);
        alert("Erreur lors du t√©l√©chargement Excel");
    } finally {
        document.body.style.cursor = 'default';
    }
}
        function filterCaisseParPersonne(nom) {
            // On cherche le menu d√©roulant des personnes
            const filterPersonne = document.getElementById('filterPersonne');
            const filterType = document.getElementById('filterTypeCaisse');
            
            if (filterPersonne) {
                // On change la valeur du filtre
                filterPersonne.value = nom;
                // On force aussi le filtre sur "Sorties" pour ne voir que ses retraits
                if (filterType) filterType.value = 'sortie';
                
                // On lance la fonction de filtrage que tu as d√©j√† dans ton code
                filterCaisse();
                
                // On fait un petit effet visuel : on remonte vers le tableau
                window.scrollTo({ top: document.querySelector('.table-container').offsetTop - 100, behavior: 'smooth' });
            }
        }
        function resetFilterCaisse() {
            // On remet tous les filtres √† z√©ro
            document.getElementById('filterPersonne').value = "";
            document.getElementById('filterTypeCaisse').value = "";
            document.getElementById('filterDateDebut').value = "";
            document.getElementById('filterDateFin').value = "";
            
            // On relance l'affichage complet
            filterCaisse();
            
            // On remonte doucement
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>
