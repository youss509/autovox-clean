<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Autovox - Gestion professionnelle de flotte automobile">
    
    <!-- PWA MANIFEST -->
    <link rel="manifest" href="manifest.json">
    
    <!-- ICONS PWA -->
    <link rel="icon" type="image/png" sizes="192x192" href="logo sans fond.jpg">
    <link rel="apple-touch-icon" href="logo sans fond.jpg">
    
    <title>Autovox - Gestion de flotte automobile</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- LIBRAIRIE EXCEL -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --success: #10b981;
            --success-hover: #059669;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --warning: #f59e0b;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-card: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.05);
            --shadow-hover: rgba(0, 0, 0, 0.1);
        }

        .dark-mode {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --shadow: rgba(0, 0, 0, 0.3);
            --shadow-hover: rgba(0, 0, 0, 0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background 0.3s, color 0.3s;
            width: 100%;
            max-width: 100vw;
            position: relative;
        }

        /* === CONNEXION === */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, #1e40af 100%);
        }
        .card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 20px 60px var(--shadow-hover);
        }
        .logo-badge {
            width: 80px; height: 80px;
            background: white; border-radius: 20px;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 20px; overflow: hidden;
        }
        .logo-badge img { width: 100%; height: 100%; object-fit: contain; }

        /* === UI ELEMENTS === */
        .btn {
            width: 100%; padding: 14px; background: var(--primary);
            color: white; border: none; border-radius: 10px;
            font-weight: 600; cursor: pointer; transition: 0.3s;
        }
        .btn-excel {
            background: var(--success) !important;
            color: white !important;
            margin-right: 12px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            border: none;
        }
        .btn-logout {
            padding: 8px 16px; background: var(--bg-secondary);
            border: 1px solid var(--border-color); border-radius: 8px;
            cursor: pointer;
        }

        /* === HEADER === */
        .header {
            background: var(--bg-card); border-bottom: 1px solid var(--border-color);
            padding: 12px 24px; display: flex; align-items: center; justify-content: space-between;
            position: sticky; top: 0; z-index: 100;
        }
        .header-nav { display: flex; gap: 8px; }
        .nav-link {
            padding: 8px 16px; border-radius: 8px; cursor: pointer;
            color: var(--text-secondary); font-weight: 500;
        }
        .nav-link.active { background: var(--primary); color: white; }

        .dashboard { display: none; min-height: 100vh; flex-direction: column; }
        .dashboard.active { display: flex; }

        .main-content { max-width: 1400px; margin: 0 auto; padding: 32px 24px; width: 100%; }
        .page-content { display: none; }
        .page-content.active { display: block; animation: fadeIn 0.3s; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* === STATS CARDS === */
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; }
        .stat-card-value { font-size: 28px; font-weight: 700; color: var(--text-primary); }

        /* === TABLES & GRIDS === */
        .vehicules-grid, .frais-grid, .ventes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .vehicule-card, .frais-card, .vente-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px; }
        
        .table-container { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; overflow-x: auto; margin-top: 24px; }
        .data-table { width: 100%; border-collapse: collapse; min-width: 700px; }
        .data-table th, .data-table td { padding: 16px; text-align: center; border-bottom: 1px solid var(--border-color); }

        /* === MOBILE === */
        .hamburger { display: none; font-size: 24px; cursor: pointer; }
        .mobile-menu { display: none; flex-direction: column; background: var(--bg-card); padding: 16px; gap: 10px; border-bottom: 1px solid var(--border-color); }
        .mobile-menu.active { display: flex; }

        @media (max-width: 768px) {
            .header-nav { display: none; }
            .hamburger { display: flex; }
            .header-right .btn-excel, .header-right .btn-logout { display: none; }
        }

        .charts-grid-2x2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
        @media (max-width: 1000px) { .charts-grid-2x2 { grid-template-columns: 1fr; } }
        .chart-container { background: var(--bg-secondary); border-radius: 12px; padding: 20px; height: 350px; }
    </style>
</head>
<body>
    <!-- CONNEXION -->
    <div class="login-container" id="loginPage">
        <div class="card">
            <div class="logo-badge"><img src="logo sans fond.jpg" alt="Autovox"></div>
            <form id="loginForm">
                <div style="margin-bottom: 15px;">
                    <label>Identifiant</label>
                    <input type="text" id="username" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;" required>
                </div>
                <div style="margin-bottom: 20px;">
                    <label>Mot de passe</label>
                    <input type="password" id="password" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;" required>
                </div>
                <button type="submit" class="btn">Se connecter</button>
            </form>
        </div>
    </div>

    <!-- DASHBOARD PRINCIPAL -->
    <div class="dashboard" id="dashboardPage">
        <header class="header">
            <div class="header-left">
                <a href="#" class="header-logo" onclick="navigateToPage('dashboard'); return false;">
                    <img src="logo sans fond.jpg" alt="Logo" style="height: 40px;">
                </a>
                <nav class="header-nav">
                    <div class="nav-link active" data-page="dashboard">ðŸ“Š Dashboard</div>
                    <div class="nav-link" data-page="vehicules">ðŸš— VÃ©hicules</div>
                    <div class="nav-link" data-page="clients">ðŸ‘¥ Clients</div>
                    <div class="nav-link" data-page="frais">ðŸ’° Frais</div>
                    <div class="nav-link" data-page="caisse">ðŸ’¼ Caisse</div>
                    <div class="nav-link" data-page="ventes">ðŸ“ˆ Ventes</div>
                    <div class="nav-link" data-page="statistiques">ðŸ“ˆ Stats</div>
                </nav>
            </div>
            <div class="header-right">
                <button class="btn-excel" onclick="exportGlobalExcel()">ðŸ“¥ Excel Premium</button>
                <button class="btn-logout" onclick="logout()">DÃ©connexion</button>
                <div class="hamburger" onclick="toggleMobileMenu()">â˜°</div>
            </div>
        </header>

        <div class="mobile-menu" id="mobileMenu">
            <div onclick="navigateToPage('dashboard'); toggleMobileMenu()">ðŸ“Š Dashboard</div>
            <div onclick="navigateToPage('vehicules'); toggleMobileMenu()">ðŸš— VÃ©hicules</div>
            <div onclick="navigateToPage('caisse'); toggleMobileMenu()">ðŸ’¼ Caisse</div>
            <div onclick="navigateToPage('statistiques'); toggleMobileMenu()">ðŸ“ˆ Statistiques</div>
            <div onclick="exportGlobalExcel()" style="color: var(--success); font-weight: bold;">ðŸ“¥ Exporter Excel</div>
            <div onclick="logout()">DÃ©connexion</div>
        </div>

        <main class="main-content">
            <!-- PAGE DASHBOARD -->
            <div class="page-content active" id="pageDashboard">
                <div class="stats">
                    <div class="stat-card"><div style="color:var(--text-secondary)">Stock</div><div class="stat-card-value" id="vehiculesStock">0</div></div>
                    <div class="stat-card"><div style="color:var(--text-secondary)">Vendus</div><div class="stat-card-value" id="vehiculesVendus">0</div></div>
                    <div class="stat-card"><div style="color:var(--text-secondary)">BÃ©nÃ©fice Net</div><div class="stat-card-value" id="beneficeTotal">0 â‚¬</div></div>
                    <div class="stat-card"><div style="color:var(--text-secondary)">Solde Caisse</div><div class="stat-card-value" id="soldeCaisse">0 â‚¬</div></div>
                </div>
                <div class="welcome-card"><h2>Bienvenue sur Autovox âœ¨</h2><p>Gestion de flotte professionnelle</p></div>
            </div>

            <!-- PAGE STATISTIQUES -->
            <div class="page-content" id="pageStatistiques">
                <h1>Analyses & Performances</h1>
                <div class="charts-grid-2x2" style="margin-top:20px;">
                    <div class="chart-container"><h3>ðŸš— Ventes / Mois</h3><canvas id="chartVentes"></canvas></div>
                    <div class="chart-container"><h3>ðŸ“ˆ CA / Mois</h3><canvas id="chartCA"></canvas></div>
                    <div class="chart-container"><h3>ðŸ’° BÃ©nÃ©fice / Mois</h3><canvas id="chartBenefice"></canvas></div>
                    <div class="chart-container"><h3>ðŸ’¸ DÃ©tail Frais</h3><div id="fraisTableContainer" style="margin-top:15px;"></div></div>
                </div>
            </div>

            <!-- PAGE CAISSE -->
            <div class="page-content" id="pageCaisse">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h1>ðŸ’¼ Gestion de la Caisse</h1>
                    <button class="btn-excel" onclick="openModalAjoutCaisse()">+ Ajouter Argent</button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead><tr><th>Date</th><th>Type</th><th>Montant</th><th>Motif</th><th>Personne</th></tr></thead>
                        <tbody id="caisseTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- PAGE VEHICULES -->
            <div class="page-content" id="pageVehicules">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h1>VÃ©hicules en Stock</h1>
                    <button class="btn-excel" onclick="openAddVehiculeModal()">+ Ajouter VÃ©hicule</button>
                </div>
                <div id="vehiculesContainer" class="vehicules-grid"></div>
            </div>

            <!-- PAGE FRAIS -->
            <div class="page-content" id="pageFrais">
                <h1>Gestion des Frais</h1>
                <div id="fraisContainer" class="frais-grid" style="margin-top:20px;"></div>
            </div>

            <!-- PAGE VENTES -->
            <div class="page-content" id="pageVentes">
                <h1>Historique des Ventes</h1>
                <div id="ventesContainer" class="ventes-grid" style="margin-top:20px;"></div>
            </div>
        </main>
    </div>

    <!-- MODAL AJOUT ARGENT -->
    <div class="modal" id="modalAjoutCaisse">
        <div class="modal-content">
            <h2>ðŸ’° Ajouter de l'argent</h2>
            <form id="formAjoutCaisse" onsubmit="ajouterArgentCaisse(event)">
                <input type="number" name="montant" placeholder="Montant â‚¬" required style="width:100%; margin:10px 0; padding:10px;">
                <input type="date" name="date" required style="width:100%; margin:10px 0; padding:10px;">
                <select name="personne" style="width:100%; margin:10px 0; padding:10px;">
                    <option>Fouad</option><option>Tarek</option><option>Walid</option><option>Riad</option>
                </select>
                <input type="text" name="motif" placeholder="Motif" required style="width:100%; margin:10px 0; padding:10px;">
                <button type="submit" class="btn">Valider</button>
                <button type="button" class="btn" style="background:#666; margin-top:5px;" onclick="closeModalAjoutCaisse()">Annuler</button>
            </form>
        </div>
    </div>

    <script>
        // CONFIGURATION
        const SUPABASE_URL = 'https://htmpyspelscwftpdrzov.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0bXB5c3BlbHNjd2Z0cGRyem92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NDQ5NTAsImV4cCI6MjA4NjQyMDk1MH0.FKv8RO32kNEI8KQACWlTgvKTn9X8N39HyKza03Rq0lY';
        let supabaseClient = null;
        let allVehicules = [], allFrais = [], allCaisse = [], allVentes = [];

        // INITIALISATION
        window.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('autovox_session') === 'active') { showDashboard(); }
        });

        function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboardPage').classList.add('active');
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            loadStats();
        }

        function navigateToPage(page) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById('page' + page.charAt(0).toUpperCase() + page.slice(1)).classList.add('active');
            const nav = document.querySelector(`.nav-link[data-page="${page}"]`);
            if(nav) nav.classList.add('active');

            if(page === 'caisse') loadCaisse();
            if(page === 'vehicules') loadVehicules();
            if(page === 'ventes') loadVentes();
            if(page === 'statistiques') loadCharts();
            if(page === 'frais') loadFrais();
        }

        // LOGIQUE CAISSE
        async function loadCaisse() {
            const { data } = await supabaseClient.from('caisse').select('*').order('date', {ascending:false});
            allCaisse = data || [];
            document.getElementById('caisseTableBody').innerHTML = allCaisse.map(c => `
                <tr>
                    <td>${new Date(c.date).toLocaleDateString()}</td>
                    <td>${c.type}</td>
                    <td style="color:${c.type==='entree'?'green':'red'}">${c.montant}â‚¬</td>
                    <td>${c.motif}</td>
                    <td>${c.personne}</td>
                </tr>
            `).join('');
            updateSolde();
        }

        async function updateSolde() {
            const { data } = await supabaseClient.rpc('get_solde_caisse');
            document.getElementById('soldeCaisse').textContent = (data || 0).toFixed(2) + ' â‚¬';
        }

        async function ajouterArgentCaisse(e) {
            e.preventDefault();
            const fd = new FormData(e.target);
            await supabaseClient.from('caisse').insert([{
                id: 'id_'+Date.now(), date: fd.get('date'), type: 'entree',
                montant: parseFloat(fd.get('montant')), personne: fd.get('personne'), motif: fd.get('motif')
            }]);
            closeModalAjoutCaisse(); loadCaisse();
        }

        // CHARGEMENT DATA
        async function loadVehicules() {
            const { data } = await supabaseClient.from('vehicules').select('*').order('marque');
            allVehicules = data || [];
            document.getElementById('vehiculesContainer').innerHTML = allVehicules.filter(v=>v.statut==='en_stock').map(v => `
                <div class="vehicule-card">
                    <h3>${v.marque} ${v.modele}</h3>
                    <p>${v.immatriculation} | ${v.kilometrage} km</p>
                    <p style="font-size:20px; font-weight:bold; color:var(--primary);">${v.prix_achat} â‚¬</p>
                </div>
            `).join('');
        }

        async function loadStats() {
            const { data } = await supabaseClient.from('vehicules').select('statut');
            if(data) {
                document.getElementById('vehiculesStock').textContent = data.filter(x=>x.statut==='en_stock').length;
                document.getElementById('vehiculesVendus').textContent = data.filter(x=>x.statut==='vendu').length;
            }
            updateSolde();
        }

        // ================================================================
        // FONCTION EXPORT EXCEL PREMIUM (COPIE CONFORME DE VOTRE IMAGE)
        // ================================================================
        async function exportGlobalExcel() {
            if (!confirm("Voulez-vous gÃ©nÃ©rer le rapport Excel de rentabilitÃ© ?")) return;
            const btn = document.querySelector('.btn-excel');
            btn.textContent = "âŒ› GÃ©nÃ©ration...";

            try {
                // 1. RÃ©cupÃ©ration des donnÃ©es
                const [vehRes, fraisRes, vntRes, cssRes] = await Promise.all([
                    supabaseClient.from('vehicules').select('*').order('marque'),
                    supabaseClient.from('frais').select('*'),
                    supabaseClient.from('ventes').select('*'),
                    supabaseClient.from('caisse').select('*')
                ]);

                const vehs = vehRes.data || [];
                const frais = fraisRes.data || [];
                const ventes = vntRes.data || [];
                const caisse = cssRes.data || [];

                // 2. PrÃ©paration du tableau principal (VÃ©hicules)
                const excelData = [];
                // En-tÃªtes (Ligne 1)
                excelData.push([
                    "MARQUE", "MODELE", "PLAQUE", "KilomÃ©trage", 
                    "PIECES ET MAINS D'OEUVRES", "CARROSSERIE", "DEPANNEUSE", 
                    "FRAIS ADMINISTRATIFS", "LAVAGE", "ESSENCE", 
                    "PRIX D'ACHAT", "PRIX TOTAL", "PRIX DE VENTE", "BÃ‰NÃ‰FICE"
                ]);

                vehs.forEach(v => {
                    // Filtrer les frais pour ce vÃ©hicule
                    const vFrais = frais.filter(f => f.vehicule_id === v.id);
                    const vVente = ventes.find(s => s.vehicule_id === v.id);

                    // CatÃ©gorisation des frais
                    let pieces = 0, carrosserie = 0, depanneuse = 0, adminStr = "", adminTotal = 0, lavage = 0, essence = 0;
                    
                    vFrais.forEach(f => {
                        const m = parseFloat(f.montant) || 0;
                        const t = f.type.toLowerCase();

                        if (t.includes('piÃ¨ces') || t.includes('entretien') || t.includes('pneus') || t.includes('clÃ©s')) {
                            pieces += m;
                        } else if (t.includes('carrosserie')) {
                            carrosserie += m;
                        } else if (t.includes('dÃ©panneuse')) {
                            depanneuse += m;
                        } else if (t.includes('lavage')) {
                            lavage += m;
                        } else if (t.includes('essence')) {
                            essence += m;
                        } else if (t.includes('dÃ©claration') || t.includes('contrÃ´le') || t.includes('annonce')) {
                            adminTotal += m;
                            let label = t.includes('dÃ©claration') ? 'DA' : t.includes('contrÃ´le') ? 'CT' : 'LBC';
                            adminStr += (adminStr ? " + " : "") + `${label} ${m}â‚¬`;
                        }
                    });

                    const prixAchat = parseFloat(v.prix_achat) || 0;
                    const totalFrais = vFrais.reduce((acc, f) => acc + (parseFloat(f.montant) || 0), 0);
                    const prixTotal = prixAchat + totalFrais;
                    const prixVente = vVente ? parseFloat(vVente.prix_vente) : 0;
                    const benefice = prixVente > 0 ? (prixVente - prixTotal) : "";

                    excelData.push([
                        v.marque, v.modele, v.immatriculation, v.kilometrage,
                        pieces > 0 ? pieces + "â‚¬" : "",
                        carrosserie > 0 ? carrosserie + "â‚¬" : "",
                        depanneuse > 0 ? depanneuse + "â‚¬" : "",
                        adminStr || (adminTotal > 0 ? adminTotal + "â‚¬" : ""),
                        lavage > 0 ? lavage + "â‚¬" : "",
                        essence > 0 ? essence + "â‚¬" : "",
                        prixAchat.toFixed(2) + "â‚¬",
                        prixTotal.toFixed(2) + "â‚¬",
                        prixVente > 0 ? prixVente + "â‚¬" : "",
                        benefice !== "" ? benefice.toFixed(0) + "â‚¬" : ""
                    ]);
                });

                // 3. Espace vide
                excelData.push([]); excelData.push([]);

                // 4. RÃ©sumÃ© par Personne (Bas du tableau)
                const personnes = ["Fouad", "Walid", "Tarek", "Riad"];
                personnes.forEach(p => {
                    const pCaisse = caisse.filter(c => c.personne === p && c.type === 'entree');
                    const totalP = pCaisse.reduce((acc, c) => acc + (parseFloat(c.montant) || 0), 0);
                    excelData.push([p.toUpperCase(), totalP > 0 ? `APPORTS: ${totalP}â‚¬` : ""]);
                });

                // 5. Ligne finale Caisse
                const { data: solde } = await supabaseClient.rpc('get_solde_caisse');
                excelData.push(["CAISSE TOTAL", (solde || 0).toFixed(2) + " â‚¬"]);

                // GÃ©nÃ©ration du fichier
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                
                // Ajustement largeur colonnes
                ws['!cols'] = [{wch:15}, {wch:15}, {wch:15}, {wch:12}, {wch:20}, {wch:15}, {wch:15}, {wch:30}, {wch:10}, {wch:10}, {wch:15}, {wch:15}, {wch:15}, {wch:15}];

                XLSX.utils.book_append_sheet(wb, ws, "RENTABILITÃ‰ AUTOVOX");
                XLSX.writeFile(wb, `Autovox_Rentabilite_${new Date().toISOString().slice(0,10)}.xlsx`);

                alert("âœ… Rapport Excel gÃ©nÃ©rÃ© avec succÃ¨s !");
            } catch (err) {
                console.error(err);
                alert("Erreur lors de l'export");
            } finally {
                btn.textContent = "ðŸ“¥ Excel Premium";
            }
        }

        // UTILS
        function toggleMobileMenu() { document.getElementById('mobileMenu').classList.toggle('active'); }
        function openModalAjoutCaisse() { document.getElementById('modalAjoutCaisse').classList.add('active'); }
        function closeModalAjoutCaisse() { document.getElementById('modalAjoutCaisse').classList.remove('active'); }
        function logout() { localStorage.removeItem('autovox_session'); location.reload(); }

        // Moteur de connexion (Simple)
        document.getElementById('loginForm').onsubmit = (e) => {
            e.preventDefault();
            if(document.getElementById('username').value === 'admin' && document.getElementById('password').value === 'autovox2026') {
                localStorage.setItem('autovox_session', 'active');
                showDashboard();
            } else { alert("Identifiants incorrects"); }
        };
    </script>
</body>
</html>
